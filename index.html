<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›Šæ™ºæ…§ç§‘æŠ€ - è¯­éŸ³å‘¼å«ç³»ç»Ÿ</title>
    <link rel="icon" href="https://oss.11yzh.com/uploads/image/20250901/e22c9032dba003091ec0b8226f39670f.png" type="image/png">
    <!-- å¼•å…¥ CryptoJS ç”¨äºMD5åŠ å¯† -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- å¼•å…¥ lame.js ç”¨äºéŸ³é¢‘æ ¼å¼è½¬æ¢ -->
    <script src="lame_simple.js"></script>
    <!-- å¼•å…¥ RecordRTC ç”¨äºéŸ³é¢‘å½•åˆ¶ -->
    <script src="https://unpkg.com/recordrtc@5.6.2/RecordRTC.js"></script>
    <!-- å¼•å…¥ lamejs ç”¨äºMP3æ ¼å¼è½¬æ¢ -->
    <script src="https://unpkg.com/lamejs@1.2.1/lame.min.js"></script>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --primary-color: #4A90E2;
            --primary-hover-color: #357ABD;
            --dark-bg: #10141f;
            --card-bg: #1a2035;
            --header-bg: #161b29;
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0b0;
            --orange-color: #ff9900;
            --teal-color: #009688;
            --red-tag-color: #f44336;
            --green-color: #4CAF50;
            --gray-tag-color: #6c757d;
            --font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: var(--font-family);
            background: #0f101a;
            color: var(--text-color);
            overflow: hidden;
            font-size: 16px;
        }

        /* --- è‡ªå®šä¹‰æ»šåŠ¨æ¡ --- */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        ::-webkit-scrollbar-thumb {
            background: #333c56;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a5474;
        }

        /* --- ç™»å½•é¡µé¢æ ·å¼ (ç»ç’ƒæ‹Ÿæ€) --- */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: url('https://web.juheiot.cn/asset/image/login_bg.a39994c8.png') no-repeat center center;
            background-size: cover;
            position: relative;
        }

        .login-box {
            position: relative;
            background-color: rgba(22, 27, 41, 0.6);
            backdrop-filter: blur(15px) saturate(120%);
            -webkit-backdrop-filter: blur(15px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 400px;
            color: #fff;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .login-logo img {
            width: 40px;
            height: 40px;
        }

        .login-logo span {
            font-size: 26px;
            font-weight: 500;
            color: #fff;
        }

        .login-box h2 {
            margin-bottom: 35px;
            color: #f0f0f0;
            font-weight: 400;
            font-size: 20px;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .input-group input {
            width: 100%;
            padding: 14px 18px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            color: #fff;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input::placeholder {
            color: #a0a0b0;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.3);
        }

        #login-button {
            width: 100%;
            padding: 14px;
            background-image: linear-gradient(45deg, var(--primary-color), var(--primary-hover-color));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
        }
        #login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        }

        #login-error {
            color: var(--red-tag-color);
            margin-top: 15px;
            height: 20px;
            font-weight: 300;
        }

        /* --- é¦–é¡µæ ·å¼ --- */
        #main-page {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: var(--dark-bg);
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            background-color: var(--header-bg);
            color: var(--text-color);
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 25px;
            font-size: 14px;
            color: var(--text-secondary-color);
        }
        .header-left .status-ok {
            color: var(--green-color);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-center img {
            width: 36px;
            height: 36px;
        }
        .header-center span {
            font-size: 22px;
            font-weight: 500;
            color: var(--text-color);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            color: var(--text-secondary-color);
        }
        .header-right .settings-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            fill: var(--text-secondary-color);
            transition: fill 0.3s, transform 0.3s;
        }
        .header-right .settings-icon:hover {
            fill: var(--text-color);
            transform: rotate(45deg);
        }

        /* è®¾ç½®ä¸‹æ‹‰æ¡†æ ·å¼ */
        .settings-container {
            position: relative;
            display: inline-block;
        }

        .settings-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            min-width: 120px;
            background-color: var(--card-bg);
            border: 1px solid #2a3149;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            margin-top: 8px;
        }

        .settings-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #2a3149;
        }

        .dropdown-item:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .main-content {
            flex-grow: 1;
            padding: 24px;
            background-color: var(--dark-bg);
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        /* æµ‹è¯•æŒ‰é’®æ ·å¼ */
        .test-button {
            padding: 8px 16px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .test-button:hover {
            background-color: #ee5253;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            background: var(--header-bg);
            padding: 6px;
            border-radius: 12px;
        }
        .tabs span {
            padding: 8px 20px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            color: var(--text-secondary-color);
            transition: all 0.3s ease;
            position: relative;
        }
        .tabs span.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.2);
        }

        .action-button {
            padding: 10px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .action-button:hover {
            background-color: var(--primary-hover-color);
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.2);
        }

        #room-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 24px;
        }

        .room-card {
            background-image: linear-gradient(135deg, #1f2740, #161b29);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 160px;
            border: 1px solid #2a3149;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header .name {
            font-size: 20px;
            font-weight: 500;
        }

        .card-tag {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
            color: white;
            font-weight: 300;
        }
        .tag-gray { background-color: var(--gray-tag-color); }
        .tag-red { background-color: var(--red-tag-color); }

        .card-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: var(--text-secondary-color);
            font-weight: 300;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary-color);
        }

        .count-badge {
            background-color: var(--orange-color);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(255, 153, 0, 0.2);
        }

        /* -- Online Card Specific Styles -- */
        .room-card.online {
            border-color: var(--orange-color);
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.2);
        }
        .room-card.online:hover {
            box-shadow: 0 0 30px rgba(255, 153, 0, 0.4);
        }

        /* å¤´åƒå®¹å™¨æ ·å¼ */
        .avatar-container {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(22, 27, 41, 0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 2px solid var(--orange-color);
        }

        /* å¤´åƒå›¾ç‰‡æ ·å¼ */
        .avatar-image {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            object-fit: cover;
        }

        /* æ¡£æ¡ˆè¯¦æƒ…æ ·å¼ */
        .archive-detail {
            color: var(--orange-color);
            font-size: 14px;
            cursor: pointer;
            transition: color 0.3s ease;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .archive-detail:hover {
            color: #ff8c00;
            text-decoration-style: solid;
        }

        .online-status {
            width: 100%;
            text-align: left;
        }

        .signal-icon {
            width: 24px;
            height: 24px;
            fill: var(--orange-color);
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #333c56;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-image: linear-gradient(90deg, #ffc107, var(--orange-color));
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        .quantity-text {
            color: var(--orange-color);
            font-weight: bold;
            font-size: 22px;
        }

        /* --- èŠå¤©å¯¹è¯æ¡†æ ·å¼ --- */
        #chat-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 650px;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border: 1px solid #2a3149;
        }

        .search-container {
            display: flex;
            align-items: center;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 8px 32px 8px 12px;
            border: none;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
            width: 200px;
            background-color: rgba(255, 255, 255, 0.9);
        }

        .search-input:focus {
            background-color: white;
        }

        .search-icon {
            position: absolute;
            right: 8px;
            width: 16px;
            height: 16px;
            fill: #666;
        }

        /* å‘¼å¸é—ªçƒåŠ¨ç”» */
        @keyframes breath {
            0% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.5);
                transform: scale(1.03);
            }
            100% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
                transform: scale(1);
            }
        }

        .breathing {
            animation: breath 2s infinite;
        }

        #chat-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 999;
        }

        #chat-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            background-color: var(--header-bg);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            flex-direction: column;
        }

        .chat-header {
            padding: 18px 24px;
            background-color: var(--header-bg);
            color: white;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--text-secondary-color);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s, transform 0.3s;
        }
        .chat-close:hover {
            color: white;
            transform: rotate(90deg);
        }

        .chat-messages {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            background-color: var(--dark-bg);
        }

        .message-item {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
            max-width: 75%;
        }

        .message-item.self-message {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 18px;
        }

        .message-item.self-message .message-avatar {
            margin: 0 0 0 16px;
            background-color: var(--green-color);
        }
        .message-item:not(.self-message) .message-avatar {
            margin: 0 16px 0 0;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .message-item.self-message .message-content {
            align-items: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        .message-item.self-message .message-header {
            flex-direction: row-reverse;
        }

        .message-name {
            font-weight: 500;
            color: var(--text-color);
        }

        .message-time {
            color: var(--text-secondary-color);
            font-size: 12px;
        }

        .message-voice {
            display: flex;
            align-items: center;
            background-color: var(--header-bg);
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .message-item:not(.self-message) .message-voice {
            border-top-left-radius: 4px;
        }

        .message-item.self-message .message-voice {
            background-color: #274869; /* Self message bubble color */
            flex-direction: row-reverse;
            border-top-right-radius: 4px;
        }

        .voice-player {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background-color 0.3s;
            font-size: 18px;
        }
        .voice-player:hover {
            background-color: var(--primary-hover-color);
        }

        .message-item.self-message .voice-player {
            background-color: var(--green-color);
            margin: 0 0 0 12px;
        }
        .message-item.self-message .voice-player:hover {
             background-color: #45a049;
        }
        .message-item:not(.self-message) .voice-player {
            margin: 0 12px 0 0;
        }


        .voice-duration {
            color: #b0b0c0;
            font-size: 14px;
            font-weight: 300;
        }

        .voice-unread {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            background-color: var(--red-tag-color);
            border: 1px solid var(--card-bg);
            border-radius: 50%;
        }

        /* èŠå¤©å¯¹è¯æ¡†åº•éƒ¨åŒºåŸŸ */
        .chat-footer {
            padding: 20px 24px;
            background-color: var(--header-bg);
            border-top: 1px solid #2a3149;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æŒ‰ä½è¯´è¯æŒ‰é’® */
        .hold-to-talk-button {
            width: 80px;
            height: 80px;
            background-image: linear-gradient(45deg, var(--primary-color), var(--primary-hover-color));
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
            user-select: none;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
        }

        .hold-to-talk-button:hover {
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.3);
            transform: scale(1.05);
        }

        .hold-to-talk-button.recording {
            background-image: linear-gradient(45deg, #f44336, #d32f2f);
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(244, 67, 54, 0.5);
        }

        /* å½•éŸ³åŠ¨ç”» */
        .hold-to-talk-button .recording-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.7);
            display: none;
            animation: recording-pulse 1.5s infinite ease-out;
        }

        .hold-to-talk-button.recording .recording-animation {
            display: block;
        }

        @keyframes recording-pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.7;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.8);
                opacity: 0;
            }
        }

        /* æ–°æ¶ˆæ¯åŠ¨ç”» */
        .new-message-animation {
            animation: new-message-fade-in 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes new-message-fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

    </style>
</head>
<body>

    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page">
        <div class="login-box">
            <div class="login-logo">
                <img src="https://oss.11yzh.com/uploads/image/20250829/f84ef2dd84e8ff52579ec07c7287c092.png" alt="Logo">
                <span>ç›Šæ™ºæ…§ç§‘æŠ€</span>
            </div>
            <h2>è¯­éŸ³å‘¼å«ç³»ç»Ÿ</h2>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="mobile" value="19808555455" required placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                </div>
                <div class="input-group">
                    <input type="password" id="password" value="admin123" required placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <p id="login-error"></p>
                <button type="submit" id="login-button">ç™» å½•</button>
            </form>
        </div>
    </div>

    <!-- é¦–é¡µ -->
    <div id="main-page">
        <header class="main-header">
            <div class="header-left">
                <span id="current-time">13:13:32</span>
                <span id="current-date">08æœˆ26æ—¥</span>
                <span>é€šè®¯: <span class="status-ok">æ­£å¸¸</span></span>
                <span id="heartbeat-status">å¿ƒè·³: 0ms</span>
            </div>
            <div class="header-center">
                <img src="https://oss.11yzh.com/uploads/image/20250829/f84ef2dd84e8ff52579ec07c7287c092.png" alt="Logo">
                <span>ç›Šæ™ºæ…§ç§‘æŠ€</span>
            </div>
            <div class="header-right">
                <span id="account-info">è´¦å·: YZHæµ‹è¯•</span>
                <div class="settings-container">
                    <svg class="settings-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="3.2"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/><circle cx="12" cy="12" r="3.2"/></svg>
                    <div id="settings-dropdown" class="settings-dropdown">
                        <div class="dropdown-item" id="logout-item">é€€å‡ºç™»å½•</div>
                        <div class="dropdown-item" id="broadcast-item">ç¾¤å‘</div>
                    </div>
                </div>
            </div>
        </header>
        <main class="main-content">
             <div class="content-header">
                <div class="tabs">
                    <span class="active" id="tab-all">å…¨éƒ¨(0)</span>
                    <span id="tab-yizh">ç›Šæ™ºæ…§(0)</span>
                </div>
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" id="room-search" placeholder="æœç´¢æˆ¿é—´åç§°" class="search-input">
                        <svg class="search-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    </div>
                </div>
            </div>
            <div id="room-container">
                <!-- æˆ¿é—´å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </main>

        <!-- èŠå¤©å¯¹è¯æ¡†é®ç½©å±‚ -->
        <div id="chat-overlay"></div>

        <!-- èŠå¤©å¯¹è¯æ¡† -->
        <div id="chat-dialog">
            <div class="chat-header">
                <h3 id="chat-title">èŠå¤©å¯¹è¯æ¡†</h3>
                <button id="chat-close" class="chat-close">&times;</button>
            </div>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-footer">
                <div id="hold-to-talk-button" class="hold-to-talk-button">
                    <span id="record-status">æŒ‰ä½è¯´è¯</span>
                    <div id="recording-animation" class="recording-animation"></div>
                </div>
            </div>
        </div>
    </div>

<script>
// JavaScript é€»è¾‘éƒ¨åˆ†ä¿æŒä¸å˜
document.addEventListener('DOMContentLoaded', () => {

    // --- å…¨å±€é…ç½® ---
    const config = {
        secret_key: "u$ii#uH!uF7LJkz&a4fcE50AdzHIbBAH",
        device_id: "62c7bb30af33cb88de7d90012383025d",
        version: "0.0.1",
        login_url: 'https://vapi.juheiot.cn/apiv1/login/index',
        get_room_url: 'https://vapi.juheiot.cn/apiv1/table/getRoom',
        get_voice_url: 'https://vapi.juheiot.cn/apiv1/table/getVoice',
        ws_url: "wss://vapi.juheiot.cn:9503/voice",
        audio_url: "https://web.juheiot.cn/asset/media/dingdong.04bd20f4.wav",
        heartbeat_interval: 30000 // 30ç§’
    };

    // --- åº”ç”¨çŠ¶æ€ ---
    const state = {
        token: null,
        websocket: null,
        heartbeat_timer: null,
        processed_messages: new Map(), // {æ¶ˆæ¯å†…å®¹: æ—¶é—´æˆ³}
        message_expire_sec: 1800, // 30åˆ†é’Ÿ
        current_room_id: null, // å½“å‰é€‰ä¸­çš„æˆ¿é—´ID
        current_room_name: null // å½“å‰é€‰ä¸­çš„æˆ¿é—´åç§°
    };

    // --- DOM å…ƒç´ å¼•ç”¨ ---
    const ui = {
        loginPage: document.getElementById('login-page'),
        mainPage: document.getElementById('main-page'),
        loginForm: document.getElementById('login-form'),
        mobileInput: document.getElementById('mobile'),
        passwordInput: document.getElementById('password'),
        loginError: document.getElementById('login-error'),
        currentTime: document.getElementById('current-time'),
        currentDate: document.getElementById('current-date'),
        heartbeatStatus: document.getElementById('heartbeat-status'),
        accountInfo: document.getElementById('account-info'),
        tabAll: document.getElementById('tab-all'),
        roomSearch: document.getElementById('room-search'),
        tabYizh: document.getElementById('tab-yizh'),
        roomContainer: document.getElementById('room-container'),
        chatDialog: document.getElementById('chat-dialog'),
        chatOverlay: document.getElementById('chat-overlay'),
        chatClose: document.getElementById('chat-close'),
        chatTitle: document.getElementById('chat-title'),
        chatMessages: document.getElementById('chat-messages'),
        holdToTalkButton: document.getElementById('hold-to-talk-button'),
        recordStatus: document.getElementById('record-status'),
        recordingAnimation: document.getElementById('recording-animation')
    };

    // --- éŸ³é¢‘æ’­æ”¾å™¨ ---
    const notificationSound = new Audio(config.audio_url);

    // --- å½•éŸ³åŠŸèƒ½ç›¸å…³å˜é‡ ---
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = 0;
    let isRecording = false;
    let audioStream = null; // å­˜å‚¨éŸ³é¢‘æµ
    let audioBlob = null; // å­˜å‚¨è½¬æ¢åçš„MP3éŸ³é¢‘Blob
    let stream = null; // ç”¨äºRecordRTCçš„éŸ³é¢‘æµ
    let localVoiceDurations = new Map(); // å­˜å‚¨æœ¬åœ°è®¡ç®—çš„è¯­éŸ³æ—¶é•¿ï¼Œkeyä¸ºmsgId

    // --- å·¥å…·å‡½æ•° ---

    /**
     * æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦åŠ è½½
     * @returns {boolean}
     */
    function checkLibraries() {
        if (typeof RecordRTC === 'undefined') {
            console.error('RecordRTC åº“æœªåŠ è½½');
            alert('é”™è¯¯ï¼šå½•éŸ³åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return false;
        }
        if (typeof lamejs === 'undefined') {
            console.warn('lamejs åº“æœªåŠ è½½ï¼Œå°†ä½¿ç”¨é»˜è®¤ç¼–ç ');
        }
        return true;
    }

    /**
     * åˆå§‹åŒ–éŸ³é¢‘å½•åˆ¶åŠŸèƒ½
     * @returns {Promise<RecordRTC|null>}
     */
    async function initAudioRecorder() {
        if (!checkLibraries()) return null;

        try {
            stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    channelCount: 1, // å•å£°é“
                    sampleRate: 44100, // 44.1kHz
                    echoCancellation: true,
                    noiseSuppression: true
                }
            });

            // ä½¿ç”¨ RecordRTC å½•åˆ¶
            mediaRecorder = RecordRTC(stream, {
                type: 'audio',
                mimeType: 'audio/webm',
                recorderType: RecordRTC.StereoAudioRecorder,
                numberOfAudioChannels: 1,
                desiredSampRate: 44100,
                bufferSize: 4096
            });

            return mediaRecorder;
        } catch (error) {
            console.error('åˆå§‹åŒ–å½•éŸ³å™¨å¤±è´¥:', error);
            alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
            return null;
        }
    }

    /**
     * å¼€å§‹å½•åˆ¶éŸ³é¢‘
     */
    async function startRecording() {
        if (isRecording || !state.current_room_id) {
            return;
        }

        if (!mediaRecorder) {
            mediaRecorder = await initAudioRecorder();
            if (!mediaRecorder) return;
        }

        // æ¸…ç©ºä¹‹å‰çš„å½•éŸ³æ•°æ®
        audioChunks = [];
        recordingStartTime = Date.now();
        isRecording = true;

        // å¼€å§‹å½•åˆ¶
        mediaRecorder.startRecording();

        // æ›´æ–°UI
        ui.holdToTalkButton.classList.add('recording');
        ui.recordStatus.textContent = 'æ¾å¼€ç»“æŸ';

        console.log('å¼€å§‹å½•éŸ³...');
    }

    /**
     * åœæ­¢å½•åˆ¶éŸ³é¢‘
     */
    function stopRecording() {
        if (!isRecording || !mediaRecorder) {
            return;
        }

        // åœæ­¢å½•åˆ¶
        mediaRecorder.stopRecording(async function() {
            const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
            const webmBlob = mediaRecorder.getBlob();

            // è½¬æ¢ä¸ºMP3æ ¼å¼
            await convertToMP3(webmBlob, duration);

            // åœæ­¢éŸ³é¢‘æµ
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            // é‡ç½®å½•éŸ³å™¨
            mediaRecorder = null;
        });

        // é‡ç½®å½•éŸ³çŠ¶æ€
        isRecording = false;

        // æ›´æ–°UI
        ui.holdToTalkButton.classList.remove('recording');
        ui.recordStatus.textContent = 'æŒ‰ä½è¯´è¯';

        console.log('åœæ­¢å½•éŸ³...æ­£åœ¨å¤„ç†éŸ³é¢‘...');
    }

    /**
     * è½¬æ¢ä¸ºMP3æ ¼å¼
     * @param {Blob} webmBlob - WebMæ ¼å¼çš„éŸ³é¢‘Blob
     * @param {number} duration - å½•éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰
     */
    async function convertToMP3(webmBlob, duration) {
        return new Promise((resolve, reject) => {
            const fileReader = new FileReader();
            fileReader.onload = function(e) {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioContext.decodeAudioData(e.target.result, async function(audioBuffer) {
                        // è½¬æ¢ä¸ºå•å£°é“
                        const channels = 1;
                        const sampleRate = 44100;
                        const kbps = 64;

                        const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, kbps);
                        const samples = audioBuffer.getChannelData(0);
                        const sampleBlockSize = 1152;
                        const mp3Data = [];

                        // è½¬æ¢ä¸º16ä½PCM
                        const samples16 = new Int16Array(samples.length);
                        for (let i = 0; i < samples.length; i++) {
                            samples16[i] = samples[i] * 0x7FFF;
                        }

                        for (let i = 0; i < samples16.length; i += sampleBlockSize) {
                            const sampleChunk = samples16.subarray(i, i + sampleBlockSize);
                            const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                            if (mp3buf.length > 0) {
                                mp3Data.push(mp3buf);
                            }
                        }

                        const mp3buf = mp3encoder.flush();
                        if (mp3buf.length > 0) {
                            mp3Data.push(mp3buf);
                        }

                        audioBlob = new Blob(mp3Data, { type: 'audio/mp3' });
                        console.log('MP3æ–‡ä»¶å·²ç”Ÿæˆï¼Œå¤§å°:', audioBlob.size, 'å­—èŠ‚');

                        // ä¸Šä¼ éŸ³é¢‘
                        if (duration > 0 && state.current_room_id) {
                            await uploadAudio(audioBlob, duration);
                        }

                        resolve();
                    }, function(error) {
                        console.error('éŸ³é¢‘è§£ç å¤±è´¥:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('MP3è½¬æ¢å¤±è´¥:', error);
                    reject(error);
                }
            };
            fileReader.onerror = reject;
            fileReader.readAsArrayBuffer(webmBlob);
        });
    }

    /**
     * ä¸Šä¼ å½•åˆ¶çš„éŸ³é¢‘åˆ°æœåŠ¡å™¨
     * @param {Blob} audioBlob - éŸ³é¢‘æ•°æ®Blob
     * @param {number} duration - å½•éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰
     */
    async function uploadAudio(audioBlob, duration) {
        if (!state.token || !state.current_room_id) {
            console.error('æœªç™»å½•æˆ–æœªé€‰æ‹©æˆ¿é—´');
            return;
        }

        try {
            // ç”Ÿæˆæ¶ˆæ¯ID
            const msgId = generateMessageId();

            // å­˜å‚¨æœ¬åœ°è®¡ç®—çš„å½•éŸ³æ—¶é•¿
            localVoiceDurations.set(msgId, duration);
            console.log('å­˜å‚¨æœ¬åœ°å½•éŸ³æ—¶é•¿:', msgId, '->', duration, 'ç§’');

            // è¯»å–MP3éŸ³é¢‘æ•°æ®ä¸ºBase64ï¼ˆä½¿ç”¨lame_test.htmlä¸­çš„è½¬ç é€»è¾‘ï¼‰
            const reader = new FileReader();
            const audioBase64 = await new Promise((resolve, reject) => {
                reader.onload = () => {
                    try {
                        let dataUrl = reader.result;
                        console.log('ç”Ÿæˆçš„DataURLï¼ˆå‰100å­—ç¬¦ï¼‰ï¼š', dataUrl.slice(0, 100)); // æ§åˆ¶å°æ‰“å°ï¼Œæ–¹ä¾¿è°ƒè¯•

                        // å¼ºå®¹é”™ï¼šä¸ç®¡æ ¼å¼å¦‚ä½•ï¼Œå¼ºåˆ¶æå–Base64éƒ¨åˆ†
                        let base64Str = '';
                        if (dataUrl.includes(',')) {
                            // æ ‡å‡†æ ¼å¼ï¼šdata:xxx;base64,xxx
                            base64Str = dataUrl.split(',')[1];
                        } else if (dataUrl.includes('base64')) {
                            // å¼‚å¸¸æ ¼å¼ï¼šç¼ºå°‘é€—å·ï¼Œç›´æ¥æˆªå–base64åçš„éƒ¨åˆ†
                            base64Str = dataUrl.split('base64')[1];
                        } else {
                            // æç«¯æƒ…å†µï¼šç›´æ¥å½“ä½œBase64ï¼ˆå¯èƒ½æ˜¯çº¯Base64æ•°æ®ï¼‰
                            base64Str = dataUrl;
                        }

                        // éªŒè¯Base64æœ‰æ•ˆæ€§ï¼ˆç®€å•æ ¡éªŒï¼šé•¿åº¦æ˜¯4çš„å€æ•°ï¼Œä¸å«éæ³•å­—ç¬¦ï¼‰
                        base64Str = base64Str.trim();
                        if (base64Str.length % 4 !== 0) {
                            // è¡¥å…¨Base64ï¼ˆç¼ºå¤±çš„=ç¬¦å·ï¼‰
                            const padLength = 4 - (base64Str.length % 4);
                            if (padLength < 4) {
                                base64Str += '='.repeat(padLength);
                            }
                        }

                        resolve(base64Str);
                    } catch (error) {
                        reject(new Error('Base64å¤„ç†å¤±è´¥: ' + error.message));
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(audioBlob);
            });

            console.log('å‡†å¤‡ä¸Šä¼ MP3éŸ³é¢‘æ•°æ®:', audioBlob.size, 'å­—èŠ‚');

            // ä½¿ç”¨ç°æœ‰generateSignå‡½æ•°ç”Ÿæˆç­¾åå’Œæ—¶é—´æˆ³ï¼Œä¸å…¶ä»–æ¥å£ä¿æŒä¸€è‡´
            const { sign, timestamp } = generateSign(state.token);

            // å‡†å¤‡è¯·æ±‚æ•°æ®ï¼Œè°ƒæ•´ä¸ºèšåˆAPIæ‰€éœ€æ ¼å¼
            const params = {
                data: audioBase64,
                duration: duration.toString(),
                msgId: msgId,
                roomId: state.current_room_id,
                type: "mp3"
            };

            // æ„é€ å®Œæ•´è¯·æ±‚å¤´ï¼Œä¸Pythonç‰ˆæœ¬ä¿æŒä¸€è‡´
            const headers = {
                "accept": "application/json, text/plain, */*",
                "accept-encoding": "gzip, deflate, br, zstd",
                "accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
                "Content-Type": "application/json",
                "deviceid": config.device_id,
                "devicetype": "pc",
                "fromapp": "pc",
                "fromplat": "all",
                "mobiletype": "web",
                "origin": "https://web.juheiot.cn",
                "referer": "https://web.juheiot.cn/",
                "sec-ch-ua": "\"Not;A=Brand\";v=\"99\", \"Microsoft Edge\";v=\"139\"",
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": "\"Windows\"",
                "sign": sign,
                "timestamp": timestamp,
                "token": state.token,
                "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Edg/139.0.0.0",
                "version": config.version
            };

            console.log('å‡†å¤‡ä¸Šä¼ éŸ³é¢‘åˆ°èšåˆAPIæ¥å£:', {
                url: 'https://vapi.juheiot.cn/apiv1/table/upVoice',
                params: params,
                headers: headers
            });

            // å‘é€è¯·æ±‚åˆ°èšåˆAPIæœåŠ¡å™¨
            const response = await fetch('https://vapi.juheiot.cn/apiv1/table/upVoice', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(params)
            });

            const result = await response.json();

            if (result.code === 200) {
                console.log('éŸ³é¢‘ä¸Šä¼ æˆåŠŸ:', result);
                // é‡æ–°è·å–æ¶ˆæ¯åˆ—è¡¨ä»¥æ›´æ–°ç•Œé¢
                const messages = await fetchVoiceMessages(state.current_room_id);
                renderVoiceMessages(messages);
            } else {
                console.error('éŸ³é¢‘ä¸Šä¼ å¤±è´¥:', result);
                console.log('--- è¯¦ç»†çš„è¿”å›ä¿¡æ¯ ---');
                console.log('çŠ¶æ€ç :', result.code || 'æœªæä¾›');
                console.log('é”™è¯¯ä¿¡æ¯:', result.message || 'æœªæä¾›');
                console.log('å®Œæ•´å“åº”:', JSON.stringify(result, null, 2));
                console.log('-------------------');
                alert('éŸ³é¢‘å‘é€å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('ä¸Šä¼ éŸ³é¢‘æ—¶å‘ç”Ÿå¼‚å¸¸:', error);
            console.log('--- å¼‚å¸¸è¯¦æƒ… ---');
            console.log('é”™è¯¯ç±»å‹:', error.name);
            console.log('é”™è¯¯ä¿¡æ¯:', error.message);
            console.log('å®Œæ•´é”™è¯¯:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
            console.log('-------------------');
            alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
        }
    }

    /**
     * ç”Ÿæˆå”¯ä¸€çš„æ¶ˆæ¯IDï¼ˆæŒ‰ç…§ç”¨æˆ·è¦æ±‚çš„æ ¼å¼ï¼šw01{timestamp}{random_num}ï¼‰
     * @returns {string}
     */
    function generateMessageId() {
        const timestamp = Date.now().toString(); // æ¯«ç§’çº§æ—¶é—´æˆ³ï¼ˆ13ä½ï¼‰
        const randomNum = Math.floor(Math.random() * 900 + 100).toString(); // 3ä½éšæœºæ•°ï¼ˆ100-999ï¼‰
        return 'w01' + timestamp + randomNum;
    }

    /**
     * ç”Ÿæˆæ¥å£ç­¾åï¼ˆä¸Pythonä»£ç ä¿æŒä¸€è‡´ï¼‰
     * @param {string} token - ç”¨æˆ·ä»¤ç‰Œ
     * @returns {{sign: string, timestamp: string}}
     */
    function generateSign(token) {
        const timestamp = String(Math.floor(Date.now() / 1000));
        const params = [
            ["token", token || ""],
            ["deviceId", config.device_id],
            ["deviceType", "pc"],
            ["fromApp", "pc"],
            ["fromPlat", "all"],
            ["mobileType", "web"],
            ["version", config.version],
            ["timestamp", timestamp]
        ];
        const paramStr = params.map(p => `${p[0]}=${p[1]}`).join(",");
        const signStr = config.secret_key + paramStr;
        const sign = CryptoJS.MD5(signStr).toString();
        return { sign, timestamp };
    }

    /**
     * æ¸…ç†è¿‡æœŸçš„å·²å¤„ç†æ¶ˆæ¯
     */
    function cleanExpiredMessages() {
        const now = Date.now();
        const expireTime = config.message_expire_sec * 1000;
        let cleanedCount = 0;
        for (const [msg, ts] of state.processed_messages.entries()) {
            if (now - ts > expireTime) {
                state.processed_messages.delete(msg);
                cleanedCount++;
            }
        }
        if (cleanedCount > 0) {
            console.log(`ğŸ—‘ï¸ æ¸…ç†äº† ${cleanedCount} æ¡è¿‡æœŸæ¶ˆæ¯ç¼“å­˜.`);
        }
    }

    /**
     * æ¨¡æ‹Ÿç™»å½•åˆ°ç®¡ç†åå° - æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œä¸å†è°ƒç”¨å®é™…ç™»å½•æ¥å£
     * @returns {Promise<boolean>} - ç™»å½•æ˜¯å¦æˆåŠŸ
     */
    async function loginToAdmin() {
        try {
            // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œä¸å†è°ƒç”¨æ—§çš„ç™»å½•æ¥å£
            // ç›´æ¥è¿”å›ç™»å½•æˆåŠŸ
            console.log('æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œä¸å†è°ƒç”¨æ—§çš„ç™»å½•æ¥å£ï¼Œç›´æ¥è¿”å›ç™»å½•æˆåŠŸ');
            localStorage.setItem('adminLoggedIn', 'true');
            return true;
        } catch (error) {
            console.error('ç®¡ç†åå°ç™»å½•å¤„ç†å¼‚å¸¸:', error);
            localStorage.setItem('adminLoggedIn', 'false');
            return false;
        }
    }

    /**
     * è·å–ç”¨æˆ·æ¡£æ¡ˆä¿¡æ¯ï¼ˆç›´æ¥è°ƒç”¨æ–°çš„APIæ¥å£ï¼‰
     * @param {string} userName - ç”¨æˆ·åï¼ˆæˆ¿é—´å·ï¼‰
     * @returns {Promise<{avatar_url: string, id: string}>}
     */
    async function getUserArchive(userName) {
        try {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (!isLoggedIn) {
                // å¦‚æœæœªç™»å½•ï¼Œå…ˆç™»å½•
                const loginSuccess = await loginToAdmin();
                if (!loginSuccess) {
                    console.error('ç®¡ç†åå°æœªç™»å½•ï¼Œæ— æ³•è·å–ç”¨æˆ·æ¡£æ¡ˆ');
                    return { avatar_url: '', id: '' };
                }
            }

            // ç›´æ¥è°ƒç”¨æ–°çš„APIæ¥å£ï¼Œä¸å†é€šè¿‡Pythonä»£ç†æœåŠ¡å™¨
            const archiveUrl = `https://admin.11yzh.com/api/userArchivers/archivers?name=${encodeURIComponent(userName)}`;

            console.log('è°ƒç”¨æ–°çš„ç”¨æˆ·æ¡£æ¡ˆAPIæ¥å£:', archiveUrl);

            // è®¾ç½®è¯·æ±‚å¤´
            const headers = {
                "accept": "application/json, text/javascript, */*; q=0.01",
                "accept-encoding": "gzip, deflate, br, zstd",
                "accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
                "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Edg/139.0.0.0"
            };

            // å‘é€æŸ¥è¯¢è¯·æ±‚
            const response = await fetch(archiveUrl, {
                method: 'GET',
                headers: headers,
                credentials: 'include' // åŒ…å«cookieä»¥ä¿æŒä¼šè¯
            });

            const result = await response.json();

            if (result && result.code === 0 && result.data && result.data.length > 0) {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const userInfo = result.data[0];
                const avatarUrl = userInfo.avatar_url || '';
                const userId = userInfo.id || '';
                
                console.log('è·å–ç”¨æˆ·æ¡£æ¡ˆæˆåŠŸ:', { avatarUrl, userId });
                
                // ä½¿ç”¨è·å–çš„idè°ƒç”¨è¯¦æƒ…æ¡£æ¡ˆæ¥å£
                if (userId) {
                    const detailUrl = `https://admin.11yzh.com/index/archives?archives_id=${userId}`;
                    console.log('å‡†å¤‡è°ƒç”¨è¯¦æƒ…æ¡£æ¡ˆæ¥å£:', detailUrl);
                    
                    // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦å¤„ç†è¯¦æƒ…æ¡£æ¡ˆæ¥å£çš„å“åº”
                    // ç”±äºç”¨æˆ·åªè¦æ±‚è°ƒç”¨è¿™ä¸ªæ¥å£ç”¨äºæ˜¾ç¤ºè¯¦æƒ…æ¡£æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨UIä¸­è·³è½¬æˆ–æ˜¾ç¤º
                    // è¿™é‡Œä»…è®°å½•æ—¥å¿—ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œå¤„ç†
                }
                
                return {
                    avatar_url: avatarUrl,
                    id: userId
                };
            } else {
                console.error('è·å–ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥:', result);
                return { avatar_url: '', id: '' };
            }
        } catch (error) {
            console.error('è¯·æ±‚ç”¨æˆ·æ¡£æ¡ˆæ—¶å‘ç”Ÿå¼‚å¸¸:', error);
            return { avatar_url: '', id: '' };
        }
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯
     * @param {string} message - æ¶ˆæ¯å†…å®¹
     * @returns {boolean}
     */
    function isNewMessage(message) {
        cleanExpiredMessages();

        // è®°å½•æ¶ˆæ¯çš„å‰50ä¸ªå­—ç¬¦ä½œä¸ºæ ‡è¯†ï¼Œé¿å…é•¿æ¶ˆæ¯å¯¼è‡´ç¼“å­˜é”®è¿‡å¤§
        const messageKey = message.length > 50 ? message.substring(0, 50) + '...' : message;

        if (state.processed_messages.has(messageKey)) {
            const timeSince = Math.floor((Date.now() - state.processed_messages.get(messageKey)) / 1000);
            console.log(`âš ï¸ æ£€æµ‹åˆ°é‡å‘æ¶ˆæ¯ (å·²ç¼“å­˜ ${timeSince} ç§’å‰), æ¶ˆæ¯å‰50å­—ç¬¦:`, messageKey);
            return false;
        } else {
            state.processed_messages.set(messageKey, Date.now());
            console.log(`âœ… æ£€æµ‹åˆ°å…¨æ–°æ¶ˆæ¯, å·²åŠ å…¥ç¼“å­˜ (å½“å‰ç¼“å­˜: ${state.processed_messages.size}), æ¶ˆæ¯å‰50å­—ç¬¦:`, messageKey);
            return true;
        }
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

    /**
     * å¤„ç†ç™»å½•é€»è¾‘
     * @param {Event} e - è¡¨å•æäº¤äº‹ä»¶
     */
    async function handleLogin(e) {
        e.preventDefault();
        ui.loginError.textContent = '';

        const { sign, timestamp } = generateSign("");
        const headers = {
            "Content-Type": "application/json",
            "deviceid": config.device_id,
            "devicetype": "pc",
            "fromapp": "pc",
            "fromplat": "all",
            "mobiletype": "web",
            "sign": sign,
            "timestamp": timestamp,
            "token": "",
            "version": config.version
        };
        const body = JSON.stringify({
            mobile: ui.mobileInput.value,
            password: ui.passwordInput.value
        });

        try {
            const response = await fetch(config.login_url, { method: 'POST', headers, body });
            const result = await response.json();

            if (result.code === 200) {
                console.log("ç™»å½•æˆåŠŸ:", result);
                state.token = result.data.token;
                ui.accountInfo.textContent = `è´¦å·: ${result.data.nickname}`;

                // åˆ‡æ¢é¡µé¢
                ui.loginPage.style.display = 'none';
                ui.mainPage.style.display = 'flex';

                // å°è¯•åœ¨ç™»å½•æˆåŠŸåæ¢å¤AudioContextï¼ˆç”¨æˆ·äº¤äº’åï¼‰
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log("ç™»å½•æˆåŠŸåAudioContextå·²æ¢å¤");
                    }).catch(e => {
                        console.error("ç™»å½•æˆåŠŸåæ¢å¤AudioContextå¤±è´¥:", e);
                    });
                }

                // è·å–æˆ¿é—´å¹¶è¿æ¥WebSocket
                await fetchRooms();
                connectWebSocket();

                // åˆå§‹åŒ–æˆ¿é—´æœç´¢åŠŸèƒ½
                initRoomSearch();

                // ç™»å½•åˆ°ç®¡ç†åå°ï¼Œä¸ºè·å–æ¡£æ¡ˆä¿¡æ¯åšå‡†å¤‡
                await loginToAdmin();
            } else {
                console.error("ç™»å½•å¤±è´¥:", result);
                ui.loginError.textContent = result.msg || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
            }
        } catch (error) {
            console.error("ç™»å½•è¯·æ±‚å¼‚å¸¸:", error);
            ui.loginError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
        }
    }

    /**
     * è·å–å¹¶æ¸²æŸ“æˆ¿é—´åˆ—è¡¨ï¼ˆå·²ä¿®å¤ç­¾åå‚æ•°é—®é¢˜ï¼‰
     */
    async function fetchRooms() {
        if (!state.token) return;

        const { sign, timestamp } = generateSign(state.token);
        // ä¿®å¤ï¼šè¡¥å……æ‰€æœ‰ç­¾åæ‰€éœ€çš„è¯·æ±‚å¤´å‚æ•°
        const headers = {
            "Content-Type": "application/json",
            "deviceid": config.device_id,
            "devicetype": "pc",
            "fromapp": "pc",
            "fromplat": "all",
            "mobiletype": "web",
            "sign": sign,
            "timestamp": timestamp,
            "token": state.token,
            "version": config.version
        };

        try {
            const response = await fetch(config.get_room_url, { headers });
            const result = await response.json();

            if (result.code === 200) {
                console.log("è·å–æˆ¿é—´æˆåŠŸ:", result);

                // ä¿å­˜åŸå§‹æˆ¿é—´æ•°æ®åˆ°localStorage
                localStorage.setItem('originalRooms', JSON.stringify(result.data.room));

                // æ¸²æŸ“æˆ¿é—´åˆ—è¡¨
                renderRooms(result.data.room);

                // æ›´æ–°Tabç»Ÿè®¡
                const totalRooms = result.data.room.length;
                const yizhRooms = result.data.room.filter(r => r.cate_name === 'ç›Šæ™ºæ…§').length;
                ui.tabAll.textContent = `å…¨éƒ¨(${totalRooms})`;
                ui.tabYizh.textContent = `ç›Šæ™ºæ…§(${yizhRooms})`;

            } else {
                console.error("è·å–æˆ¿é—´å¤±è´¥:", result);
            }
        } catch (error) {
            console.error("è·å–æˆ¿é—´è¯·æ±‚å¼‚å¸¸:", error);
        }
    }

    /**
     * æ ¹æ®æ•°æ®æ¸²æŸ“æˆ¿é—´å¡ç‰‡
     * @param {Array} rooms - æˆ¿é—´æ•°æ®æ•°ç»„
     */
    function renderRooms(rooms) {
        ui.roomContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰å¡ç‰‡
        rooms.forEach(room => {
            const isOnline = room.device && room.device.is_online === 1;
            const hasMessages = room.count > 0;

            // å†³å®šå¡ç‰‡é¢œè‰²å’ŒçŠ¶æ€
            const cardClass = (isOnline || hasMessages) ? 'online' : '';

            let bodyContent = '';
            let footerContent = `<span class="category-name">${room.cate_name}</span>`;

            if(isOnline) {
                bodyContent = `
                    <div class="online-status">
                        <span class="quantity-text">${room.device.quantity}%</span>
                        <div class="progress-bar-container">
                           <div class="progress-bar" style="width: ${room.device.quantity}%;"></div>
                        </div>
                    </div>
                `;
                footerContent = `
                    <svg class="signal-icon" viewBox="0 0 1024 1024"><path d="M224 768h-64v128h64v-128z m192 192h-64v-320h64v320z m192-448h-64v576h64v-576z m192-192h-64v768h64v-768z"></path></svg>
                    ${footerContent}
                `;
            } else {
                 bodyContent = `<span>${room.cate_name}</span>`;
            }

            if(hasMessages){
                footerContent += `<span class="count-badge">${room.count}æ¡</span>`;
            }

            const cardHTML = `
                <div class="room-card ${cardClass}" data-room-id="${room.id}" data-room-name="${room.name}">
                    <!-- ç”¨äºæ˜¾ç¤ºå¤´åƒçš„å®¹å™¨ -->
                    <div class="avatar-container" style="display: none;">
                        <img class="avatar-image" src="" alt="å¤´åƒ">
                    </div>

                    <div class="card-header">
                        <span class="name">${room.name}</span>
                        ${!isOnline ? `<span class="card-tag ${hasMessages ? 'tag-red' : 'tag-gray'}">æœªæ»¡</span>` : ''}
                    </div>
                    <div class="card-body">
                       ${bodyContent}
                    </div>
                    <div class="card-footer">
                        ${footerContent}
                        <span class="archive-detail" data-room-name="${room.name}">æ¡£æ¡ˆè¯¦æƒ…</span>
                    </div>
                </div>
            `;
            ui.roomContainer.insertAdjacentHTML('beforeend', cardHTML);
        });

        // ä¸ºæˆ¿é—´å¡ç‰‡æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.querySelectorAll('.room-card').forEach(card => {
            // å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆæ‰“å¼€èŠå¤©å¯¹è¯æ¡†ï¼‰
            card.addEventListener('click', (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ¡£æ¡ˆè¯¦æƒ…ï¼Œåˆ™ä¸æ‰“å¼€èŠå¤©å¯¹è¯æ¡†
                if (e.target.classList.contains('archive-detail')) {
                    return;
                }
                const roomId = card.getAttribute('data-room-id');
                const roomName = card.getAttribute('data-room-name');
                openChatDialog(roomId, roomName);
            });

            // é¼ æ ‡æ‚¬æµ®äº‹ä»¶ï¼ˆæ˜¾ç¤ºå¤´åƒï¼‰
            card.addEventListener('mouseenter', async () => {
                const roomName = card.getAttribute('data-room-name');
                const avatarContainer = card.querySelector('.avatar-container');
                const avatarImage = card.querySelector('.avatar-image');

                // æ˜¾ç¤ºå¤´åƒå®¹å™¨
                avatarContainer.style.display = 'block';

                // è·å–ç”¨æˆ·æ¡£æ¡ˆä¿¡æ¯
                const userInfo = await getUserArchive(roomName);
                if (userInfo.avatar_url) {
                    avatarImage.src = userInfo.avatar_url;
                    // å­˜å‚¨ç”¨æˆ·IDåˆ°æ¡£æ¡ˆè¯¦æƒ…å…ƒç´ 
                    const archiveDetail = card.querySelector('.archive-detail');
                    archiveDetail.setAttribute('data-archive-id', userInfo.id);
                }
            });

            // é¼ æ ‡ç¦»å¼€äº‹ä»¶ï¼ˆéšè—å¤´åƒï¼‰
            card.addEventListener('mouseleave', () => {
                const avatarContainer = card.querySelector('.avatar-container');
                avatarContainer.style.display = 'none';
            });

            // æ¡£æ¡ˆè¯¦æƒ…ç‚¹å‡»äº‹ä»¶
            const archiveDetail = card.querySelector('.archive-detail');
            archiveDetail.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                const archiveId = archiveDetail.getAttribute('data-archive-id');
                if (archiveId) {
                    window.open(`https://admin.11yzh.com/index/archives?archives_id=${archiveId}`, '_blank');
                } else {
                    // å¦‚æœæ²¡æœ‰IDï¼Œå°è¯•è·å–ä¸€æ¬¡
                    const roomName = card.getAttribute('data-room-name');
                    getUserArchive(roomName).then(userInfo => {
                        if (userInfo.id) {
                            window.open(`https://admin.11yzh.com/index/archives?archives_id=${userInfo.id}`, '_blank');
                        } else {
                            alert('æ— æ³•è·å–æ¡£æ¡ˆä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•');
                        }
                    });
                }
            });
        });
    }

    /**
     * æœç´¢æˆ¿é—´åŠŸèƒ½
     */
    function initRoomSearch() {
        // ä¿å­˜åŸå§‹æˆ¿é—´åˆ—è¡¨ï¼Œç”¨äºæœç´¢æ—¶æ¢å¤
        let originalRooms = [];
        let currentFilter = 'all'; // 'all' æˆ– 'yizh'

        // ç›‘å¬tabåˆ‡æ¢ï¼Œä¿å­˜å½“å‰è¿‡æ»¤å™¨
        ui.tabAll.addEventListener('click', () => {
            currentFilter = 'all';
            performSearch(ui.roomSearch.value);
        });

        ui.tabYizh.addEventListener('click', () => {
            currentFilter = 'yizh';
            performSearch(ui.roomSearch.value);
        });

        // ç›‘å¬æœç´¢æ¡†è¾“å…¥
        ui.roomSearch.addEventListener('input', function() {
            performSearch(this.value);
        });

        // å½“æˆ¿é—´åˆ—è¡¨åŠ è½½å®Œæˆåï¼Œä¿å­˜åŸå§‹æ•°æ®
        const originalFetchRooms = fetchRooms;
        fetchRooms = async function() {
            const result = await originalFetchRooms();

            // é‡æ–°è·å–æˆ¿é—´åˆ—è¡¨å¹¶ä¿å­˜
            if (!state.token) return;

            try {
                const { sign, timestamp } = generateSign(state.token);
                const headers = {
                    "Content-Type": "application/json",
                    "deviceid": config.device_id,
                    "devicetype": "pc",
                    "fromapp": "pc",
                    "fromplat": "all",
                    "mobiletype": "web",
                    "sign": sign,
                    "timestamp": timestamp,
                    "token": state.token,
                    "version": config.version
                };

                const response = await fetch(config.get_room_url, { headers });
                const data = await response.json();

                if (data.code === 200) {
                    originalRooms = data.data.room;
                }
            } catch (error) {
                console.error("è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥:", error);
            }

            return result;
        };

        // æ‰§è¡Œæœç´¢
        function performSearch(keyword) {
            // å¦‚æœæ²¡æœ‰åŸå§‹æˆ¿é—´æ•°æ®ï¼Œåˆ™å…ˆè·å–
            if (!originalRooms || originalRooms.length === 0) {
                fetchRooms();
                return;
            }

            // è¿‡æ»¤æˆ¿é—´åˆ—è¡¨
            let filteredRooms = [...originalRooms];

            // åº”ç”¨åˆ†ç±»è¿‡æ»¤
            if (currentFilter === 'yizh') {
                filteredRooms = filteredRooms.filter(room => room.cate_name === 'ç›Šæ™ºæ…§');
            }

            // åº”ç”¨å…³é”®è¯æœç´¢
            if (keyword.trim()) {
                // æ¨¡ç³Šæœç´¢æˆ¿é—´åç§°åŒ…å«å…³é”®è¯çš„æˆ¿é—´
                filteredRooms = filteredRooms.filter(room =>
                    room.name && room.name.includes(keyword.trim())
                );
            }

            // æ›´æ–°Tabç»Ÿè®¡
            const totalRooms = keyword.trim() ? filteredRooms.length : originalRooms.length;
            const yizhRooms = keyword.trim()
                ? filteredRooms.filter(r => r.cate_name === 'ç›Šæ™ºæ…§').length
                : originalRooms.filter(r => r.cate_name === 'ç›Šæ™ºæ…§').length;

            ui.tabAll.textContent = `å…¨éƒ¨(${totalRooms})`;
            ui.tabYizh.textContent = `ç›Šæ™ºæ…§(${yizhRooms})`;

            // æ¸²æŸ“è¿‡æ»¤åçš„æˆ¿é—´åˆ—è¡¨
            renderRooms(filteredRooms);
        }
    }

    /**
     * è·å–è¯­éŸ³æ¶ˆæ¯åˆ—è¡¨
     * @param {number} roomId - æˆ¿é—´ID
     * @param {number} page - é¡µç 
     * @returns {Promise<Array>} - è¯­éŸ³æ¶ˆæ¯åˆ—è¡¨
     */
     function playVoice(url) {
        const audio = new Audio(url);
        audio.play().then(() => {
            console.log("ğŸµ æ­£åœ¨æ’­æ”¾è¯­éŸ³:", url);
        }).catch(err => {
            console.error("è¯­éŸ³æ’­æ”¾å¤±è´¥:", err);
        });
    }
    async function fetchVoiceMessages(roomId, page = 1) {
        if (!state.token) return [];

        const { sign, timestamp } = generateSign(state.token);
        const headers = {
            "Content-Type": "application/json",
            "deviceid": config.device_id,
            "devicetype": "pc",
            "fromapp": "pc",
            "fromplat": "all",
            "mobiletype": "web",
            "sign": sign,
            "timestamp": timestamp,
            "token": state.token,
            "version": config.version
        };

        const body = JSON.stringify({
            id: roomId,
            page: page
        });

        try {
            const response = await fetch(config.get_voice_url, { method: 'POST', headers, body });
            const result = await response.json();

            if (result.code === 200) {
                console.log("è·å–è¯­éŸ³æ¶ˆæ¯æˆåŠŸ:", result);
                return result.data.list || [];
            } else {
                console.error("è·å–è¯­éŸ³æ¶ˆæ¯å¤±è´¥:", result);
                return [];
            }
        } catch (error) {
            console.error("è·å–è¯­éŸ³æ¶ˆæ¯è¯·æ±‚å¼‚å¸¸:", error);
            return [];
        }
    }

    /**
     * æ¸²æŸ“è¯­éŸ³æ¶ˆæ¯åˆ—è¡¨
     * @param {Array} messages - è¯­éŸ³æ¶ˆæ¯åˆ—è¡¨
     */
    function renderVoiceMessages(messages) {
        ui.chatMessages.innerHTML = ''; // æ¸…ç©ºç°æœ‰æ¶ˆæ¯

        if (messages.length === 0) {
            ui.chatMessages.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ¶ˆæ¯</div>';
            return;
        }

        messages.forEach(message => {
            // æ ¼å¼åŒ–æ—¶é—´
            const date = new Date(message.time * 1000);
            const formattedTime = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

            // æ£€æµ‹æ˜¯å¦ä¸ºè‡ªå·±å‘é€çš„æ¶ˆæ¯
            // 1. å¦‚æœroomNameåŒ…å«'æ€»å°'ï¼Œåˆ™ä¸ºè‡ªå·±å‘é€çš„æ¶ˆæ¯
            // 2. å¦‚æœæ˜¯é€šè¿‡upVoiceæ¥å£å‘é€çš„æ¶ˆæ¯ï¼ˆæ¶ˆæ¯IDä»¥'w01'å¼€å¤´ï¼‰ï¼Œä¹Ÿè§†ä¸ºè‡ªå·±å‘é€çš„æ¶ˆæ¯
            const isSelfMessage = (message.roomName && message.roomName.includes('æ€»å°')) ||
                                (message.msgId && message.msgId.startsWith('w01'));

            // è®¾ç½®æ¶ˆæ¯æ ·å¼ç±»
            const messageItemClass = isSelfMessage ? 'message-item self-message' : 'message-item';

            // è‡ªå·±å‘é€çš„æ¶ˆæ¯ä½¿ç”¨ç‰¹å®šåç§°å’Œå¤´åƒ
            let displayName = message.roomName;
            let avatarText = message.roomName.charAt(0);

            // ä½¿ç”¨æœ¬åœ°è®¡ç®—çš„å½•éŸ³æ—¶é•¿ï¼ˆå¦‚æœæœ‰ï¼‰
            let displayDuration = message.duration;
            if (isSelfMessage && message.msgId && localVoiceDurations.has(message.msgId)) {
                displayDuration = localVoiceDurations.get(message.msgId);
                console.log('ä½¿ç”¨æœ¬åœ°å½•éŸ³æ—¶é•¿:', message.msgId, '->', displayDuration, 'ç§’');
                // å¯ä»¥è€ƒè™‘åœ¨ä½¿ç”¨åæ¸…é™¤ç¼“å­˜ï¼Œé¿å…å†…å­˜å ç”¨
                // localVoiceDurations.delete(message.msgId);
            }

            // æ ¹æ®è¯­éŸ³æ—¶é•¿è®¡ç®—è¯­éŸ³æ¡çš„å®½åº¦
            // åŸºç¡€å®½åº¦60pxï¼Œæ¯ç§’é’Ÿå¢åŠ 10pxï¼Œæœ€å¤§å®½åº¦300px
            const baseWidth = 60;
            const widthPerSecond = 10;
            const maxWidth = 300;
            const calculatedWidth = Math.min(baseWidth + (displayDuration * widthPerSecond), maxWidth);
            const voiceBarStyle = `width: ${calculatedWidth}px;`;

            if (isSelfMessage && message.msgId && message.msgId.startsWith('w01')) {
                // å¯¹äºé€šè¿‡upVoiceæ¥å£å‘é€çš„æ¶ˆæ¯ï¼Œä½¿ç”¨'æ€»å°'ä½œä¸ºæ˜¾ç¤ºåç§°
                displayName = 'æ€»å°';
                avatarText = 'æ€»';
            }

            // æ ¹æ®æ¶ˆæ¯å‘é€è€…å†³å®šå¤´åƒå’Œæ°”æ³¡çš„ä½ç½®
            let messageHTML;
            if (isSelfMessage) {
                // è‡ªå·±å‘é€çš„æ¶ˆæ¯ - å³ä¾§æ˜¾ç¤ºï¼Œå†…å®¹åœ¨å³ä¾§ï¼Œä¸æ˜¾ç¤ºå¤´åƒ
                messageHTML = `
                    <div class="${messageItemClass}">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-time">${formattedTime}</span>
                                <span class="message-name">${displayName}</span>
                            </div>
                            <div class="message-voice" style="${voiceBarStyle}">
                                <span class="voice-duration">${displayDuration}ç§’</span>
                                <button class="voice-player" data-audio-src="${message.msgFile.trim()}">
                                    â–¶
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // å¯¹æ–¹å‘é€çš„æ¶ˆæ¯ - å·¦ä¾§æ˜¾ç¤ºï¼Œå¤´åƒåœ¨å·¦ï¼Œå†…å®¹åœ¨å¤´åƒå³ä¾§
                messageHTML = `
                    <div class="${messageItemClass}">
                        <div class="message-avatar">${avatarText}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-name">${displayName}</span>
                                <span class="message-time">${formattedTime}</span>
                            </div>
                            <div class="message-voice" style="${voiceBarStyle}">
                                <button class="voice-player" data-audio-src="${message.msgFile.trim()}">
                                    â–¶
                                </button>
                                <span class="voice-duration">${displayDuration}ç§’</span>
                                ${message.isRead === 0 ? '<div class="voice-unread"></div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            ui.chatMessages.insertAdjacentHTML('beforeend', messageHTML);
        });

        // ä¸ºè¯­éŸ³æ’­æ”¾å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.voice-player').forEach(player => {
            player.addEventListener('click', function() {
                const audioSrc = this.getAttribute('data-audio-src');
                playAudio(audioSrc, this);
            });
        });

        // æ»šåŠ¨åˆ°åº•éƒ¨
        ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
    }

    /**
     * å¤„ç†WebSocketæ¥æ”¶åˆ°çš„æ–°æ¶ˆæ¯
     * @param {Object} messageData - æ¶ˆæ¯æ•°æ®
     */
    function handleNewMessageNotification(messageData) {
        console.log(`[è°ƒè¯•] handleNewMessageNotification è¢«è°ƒç”¨ï¼Œæ¶ˆæ¯æ•°æ®:`, messageData);

        // æ’­æ”¾æç¤ºéŸ³
        notificationSound.play().catch(e => console.error("æç¤ºéŸ³æ’­æ”¾å¤±è´¥:", e));

        // æ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥
        showNotification("æ–°æ¶ˆæ¯", `æ”¶åˆ°æ¥è‡ª ${messageData.roomName || 'æœªçŸ¥æˆ¿é—´'} çš„æ¶ˆæ¯`);

        // æ›´æ–°æˆ¿é—´æœªè¯»è®¡æ•°
        updateRoomUnreadCount(messageData.roomId);

        console.log("ğŸ”Š æ’­æ”¾æ–°æ¶ˆæ¯æç¤ºéŸ³å¹¶æ˜¾ç¤ºé€šçŸ¥");
    }

    /**
     * æµ‹è¯•æ–°æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½
     */
    function testNewMessageNotification() {
        console.log("[è°ƒè¯•] æ‰‹åŠ¨æµ‹è¯•æ–°æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½");
        // è·å–ç¬¬ä¸€ä¸ªæˆ¿é—´å¡ç‰‡çš„IDå’Œåç§°
        const firstRoomCard = document.querySelector('.room-card');
        if (firstRoomCard) {
            const roomId = firstRoomCard.getAttribute('data-room-id');
            const roomName = firstRoomCard.getAttribute('data-room-name');

            if (roomId && roomName) {
                console.log(`[è°ƒè¯•] æµ‹è¯•æ¶ˆæ¯å°†å‘é€åˆ°æˆ¿é—´: ${roomName} (ID: ${roomId})`);
                handleNewMessageNotification({
                    roomId: roomId,
                    roomName: roomName
                });
            } else {
                console.log("[è°ƒè¯•] æœªæ‰¾åˆ°æœ‰æ•ˆçš„æˆ¿é—´æ•°æ®");
            }
        } else {
            console.log("[è°ƒè¯•] æœªæ‰¾åˆ°ä»»ä½•æˆ¿é—´å¡ç‰‡");
        }
    }

    /**
     * æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥
     * @param {string} title - é€šçŸ¥æ ‡é¢˜
     * @param {string} body - é€šçŸ¥å†…å®¹
     */
    function showNotification(title, body) {
        if (!('Notification' in window)) {
            console.log("æ­¤æµè§ˆå™¨ä¸æ”¯æŒæ¡Œé¢é€šçŸ¥");
            return;
        }

        // å¦‚æœç”¨æˆ·å·²æˆæƒï¼Œåˆ™åˆ›å»ºé€šçŸ¥
        if (Notification.permission === 'granted') {
            new Notification(title, {
                body: body,
                icon: './favicon.ico',
                requireInteraction: false
            });
        } else if (Notification.permission !== 'denied') {
            // å¦‚æœç”¨æˆ·å°šæœªé€‰æ‹©ï¼Œåˆ™è¯·æ±‚æƒé™
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    new Notification(title, {
                        body: body,
                        icon: './favicon.ico',
                        requireInteraction: false
                    });
                }
            });
        }
    }

    /**
     * æ›´æ–°æˆ¿é—´æœªè¯»è®¡æ•°
     * @param {number} roomId - æˆ¿é—´ID
     */
    function updateRoomUnreadCount(roomId) {
        console.log(`[è°ƒè¯•] updateRoomUnreadCount è¢«è°ƒç”¨ï¼ŒroomId: ${roomId}`);

        // æŸ¥æ‰¾å¯¹åº”æˆ¿é—´å¡ç‰‡å¹¶æ›´æ–°æœªè¯»è®¡æ•°
        const roomCard = document.querySelector(`.room-card[data-room-id="${roomId}"]`);

        if (roomCard) {
            console.log(`[è°ƒè¯•] æ‰¾åˆ°æˆ¿é—´å¡ç‰‡: ${roomCard.getAttribute('data-room-name')}`);

            // è·å–æœªè¯»è®¡æ•°å…ƒç´ 
            const unreadCountElement = roomCard.querySelector('.unread-count');
            if (!unreadCountElement) {
                console.log(`[è°ƒè¯•] æœªæ‰¾åˆ°æœªè¯»è®¡æ•°å…ƒç´ ï¼Œåˆ›å»ºæ–°çš„è®¡æ•°å…ƒç´ `);
                // å¦‚æœæ²¡æœ‰æœªè¯»è®¡æ•°å…ƒç´ ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
                const footer = roomCard.querySelector('.card-footer');
                if (footer) {
                    const badge = document.createElement('span');
                    badge.className = 'count-badge unread-count';
                    badge.textContent = '1';
                    footer.appendChild(badge);
                    console.log(`[è°ƒè¯•] å·²åˆ›å»ºæ–°çš„æœªè¯»è®¡æ•°å…ƒç´ `);
                } else {
                    console.log(`[è°ƒè¯•] æœªæ‰¾åˆ°å¡ç‰‡åº•éƒ¨å…ƒç´ ï¼Œæ— æ³•åˆ›å»ºæœªè¯»è®¡æ•°`);
                }
            } else {
                console.log(`[è°ƒè¯•] æ‰¾åˆ°æœªè¯»è®¡æ•°å…ƒç´ ï¼Œå½“å‰è®¡æ•°: ${unreadCountElement.textContent || '0'}`);
                // æ›´æ–°æœªè¯»è®¡æ•°
                let count = parseInt(unreadCountElement.textContent || '0') + 1;
                unreadCountElement.textContent = count;
                unreadCountElement.style.display = 'flex';
                console.log(`[è°ƒè¯•] æ›´æ–°åçš„æœªè¯»è®¡æ•°: ${count}`);
            }

            // æ·»åŠ å‘¼å¸é—ªçƒæ•ˆæœ
            console.log(`[è°ƒè¯•] æ·»åŠ å‘¼å¸é—ªçƒæ•ˆæœ`);
            roomCard.classList.add('breathing');

            // 5ç§’åè‡ªåŠ¨ç§»é™¤é—ªçƒæ•ˆæœ
            setTimeout(() => {
                if (roomCard) {
                    console.log(`[è°ƒè¯•] ç§»é™¤å‘¼å¸é—ªçƒæ•ˆæœ`);
                    roomCard.classList.remove('breathing');
                }
            }, 5000);

            // å°†æˆ¿é—´å¡ç‰‡ç½®é¡¶
            const container = roomCard.parentElement;
            if (container && container.firstChild !== roomCard) {
                console.log(`[è°ƒè¯•] å‡†å¤‡å°†æˆ¿é—´å¡ç‰‡ç½®é¡¶`);
                // ä¿å­˜åŸå§‹æˆ¿é—´æ•°æ®
                const originalRooms = JSON.parse(localStorage.getItem('originalRooms') || '[]');
                console.log(`[è°ƒè¯•] localStorageä¸­çš„æˆ¿é—´æ•°æ®æ•°é‡: ${originalRooms.length}`);
                if (originalRooms.length > 0) {
                    // æ‰¾åˆ°å¯¹åº”çš„æˆ¿é—´æ•°æ®
                    const roomIndex = originalRooms.findIndex(room => room.id == roomId);
                    if (roomIndex !== -1) {
                        console.log(`[è°ƒè¯•] æ‰¾åˆ°æˆ¿é—´æ•°æ®ï¼Œç´¢å¼•: ${roomIndex}`);
                        // å°†æˆ¿é—´æ•°æ®ç§»åˆ°æ•°ç»„å¼€å¤´
                        const roomData = originalRooms.splice(roomIndex, 1)[0];
                        originalRooms.unshift(roomData);
                        localStorage.setItem('originalRooms', JSON.stringify(originalRooms));
                        console.log(`[è°ƒè¯•] å·²æ›´æ–°localStorageä¸­çš„æˆ¿é—´é¡ºåº`);
                    } else {
                        console.log(`[è°ƒè¯•] æœªåœ¨localStorageä¸­æ‰¾åˆ°å¯¹åº”æˆ¿é—´æ•°æ®`);
                    }
                } else {
                    console.log(`[è°ƒè¯•] localStorageä¸­æ²¡æœ‰æˆ¿é—´æ•°æ®`);
                }

                // ä»DOMä¸­ç§»é™¤å¡ç‰‡å¹¶æ·»åŠ åˆ°å®¹å™¨å¼€å¤´
                console.log(`[è°ƒè¯•] æ‰§è¡ŒDOMæ“ä½œï¼Œå°†å¡ç‰‡ç§»åˆ°å®¹å™¨å¼€å¤´`);
                container.removeChild(roomCard);
                container.insertBefore(roomCard, container.firstChild);
                console.log(`[è°ƒè¯•] å¡ç‰‡ç½®é¡¶æ“ä½œå®Œæˆ`);
            } else {
                console.log(`[è°ƒè¯•] å¡ç‰‡å·²ç»åœ¨é¡¶éƒ¨æˆ–æ²¡æœ‰çˆ¶å®¹å™¨ï¼Œæ— éœ€ç½®é¡¶`);
            }
        } else {
            console.log(`[è°ƒè¯•] æœªæ‰¾åˆ°æˆ¿é—´å¡ç‰‡ï¼ŒroomId: ${roomId}`);
            // å¦‚æœæœªæ‰¾åˆ°æˆ¿é—´å¡ç‰‡ï¼Œå°è¯•é‡æ–°æ¸²æŸ“æˆ¿é—´åˆ—è¡¨
            setTimeout(() => {
                fetchRooms().then(() => {
                    console.log(`[è°ƒè¯•] é‡æ–°è·å–æˆ¿é—´åˆ—è¡¨åå†æ¬¡å°è¯•æ›´æ–°æœªè¯»è®¡æ•°`);
                    const retryCard = document.querySelector(`.room-card[data-room-id="${roomId}"]`);
                    if (retryCard) {
                        console.log(`[è°ƒè¯•] é‡æ–°è·å–åæ‰¾åˆ°æˆ¿é—´å¡ç‰‡: ${retryCard.getAttribute('data-room-name')}`);
                    }
                });
            }, 1000);
        }
    }

    // å…¨å±€AudioContextï¼Œç”¨äºæ’­æ”¾éŸ³é¢‘
     let audioContext = null;

     // åœ¨é¡µé¢åŠ è½½æ—¶å°±å°è¯•åˆå§‹åŒ–AudioContextï¼Œä½†å®ƒä¼šè¢«æµè§ˆå™¨è‡ªåŠ¨æš‚åœ
     try {
         audioContext = new (window.AudioContext || window.webkitAudioContext)();
         console.log("AudioContextå·²åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–");
     } catch (e) {
         console.error("é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–Web Audio APIå¤±è´¥:", e);
     }

     // æ·»åŠ å…¨å±€ç”¨æˆ·äº¤äº’äº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨äºæ¢å¤AudioContext
     document.addEventListener('click', function initAudioOnUserInteraction() {
         if (audioContext && audioContext.state === 'suspended') {
             audioContext.resume().then(() => {
                 console.log("AudioContextå·²åœ¨ç”¨æˆ·é¦–æ¬¡äº¤äº’æ—¶æ¢å¤");
             }).catch(e => {
                 console.error("æ¢å¤AudioContextå¤±è´¥:", e);
             });
         }
         // ç§»é™¤è¿™ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤è°ƒç”¨
         document.removeEventListener('click', initAudioOnUserInteraction);
     }, { once: true });

     // ç¡®ä¿AudioContextå·²åˆå§‹åŒ–ï¼ˆåœ¨ç”¨æˆ·äº¤äº’æ—¶ï¼‰
     function initAudioContext() {
        if (!audioContext) {
            try {
                // åˆ›å»ºAudioContextå®ä¾‹
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("AudioContextå·²åˆå§‹åŒ–");
            } catch (e) {
                console.error("æ— æ³•åˆå§‹åŒ–Web Audio API:", e);
            }
        }

        // æ£€æŸ¥AudioContextæ˜¯å¦è¢«æš‚åœï¼ˆè‡ªåŠ¨æ’­æ”¾ç­–ç•¥ï¼‰
        if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                console.log("AudioContextå·²æ¢å¤ï¼ŒçŠ¶æ€:", audioContext.state);
            }).catch(e => {
                console.error("æ¢å¤AudioContextå¤±è´¥:", e);
            });
        }

        console.log("å½“å‰AudioContextçŠ¶æ€:", audioContext ? audioContext.state : 'æœªåˆå§‹åŒ–');
        return audioContext;
    }

     /**
      * æ’­æ”¾éŸ³é¢‘ï¼ˆä½¿ç”¨Web Audio APIç»•è¿‡è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
      * @param {string} audioSrc - éŸ³é¢‘URL
      * @param {HTMLElement} button - æ’­æ”¾æŒ‰é’®å…ƒç´ 
      */
     async function playAudio(audioSrc, button) {
         console.log("ç”¨æˆ·ç‚¹å‡»éŸ³é¢‘æ’­æ”¾æŒ‰é’®ï¼Œå°è¯•æ’­æ”¾éŸ³é¢‘:", audioSrc);

         // æ£€æŸ¥å‚æ•°æ˜¯å¦æœ‰æ•ˆ
         if (!audioSrc || !button) {
             console.error("æ— æ•ˆçš„å‚æ•°: audioSrc=", audioSrc, "button=", button);
             return;
         }

         // é¦–å…ˆå°è¯•æ¢å¤AudioContextï¼Œæ— è®ºæ˜¯å¦å·²åˆå§‹åŒ–
         if (audioContext && audioContext.state === 'suspended') {
             try {
                 await audioContext.resume();
                 console.log("åœ¨playAudioå‡½æ•°ä¸­æ¢å¤AudioContextæˆåŠŸï¼Œå½“å‰çŠ¶æ€:", audioContext.state);
             } catch (e) {
                 console.error("åœ¨playAudioå‡½æ•°ä¸­æ¢å¤AudioContextå¤±è´¥:", e);
             }
         }

         // åˆå§‹åŒ–AudioContext
         const ctx = initAudioContext();
         if (!ctx) {
             console.error("æ— æ³•æ’­æ”¾éŸ³é¢‘ï¼ŒAudioContextæœªåˆå§‹åŒ–");
             alert("éŸ³é¢‘æ’­æ”¾å¤±è´¥: æ— æ³•åˆå§‹åŒ–Web Audio API");
             return;
         }

         if (ctx.state !== 'running') {
             console.warn(`AudioContextçŠ¶æ€ä¸æ˜¯runningï¼Œè€Œæ˜¯${ctx.state}`);
             try {
                 await ctx.resume();
                 console.log("åœ¨playAudioä¸­å†æ¬¡å°è¯•æ¢å¤AudioContextï¼ŒçŠ¶æ€å˜ä¸º:", ctx.state);
             } catch (e) {
                 console.error("åœ¨playAudioä¸­å†æ¬¡å°è¯•æ¢å¤AudioContextå¤±è´¥:", e);
                 alert(`éŸ³é¢‘æ’­æ”¾å¤±è´¥: æ— æ³•æ¢å¤AudioContext (çŠ¶æ€: ${ctx.state})`);
                 return;
             }
         }

         // åœæ­¢å…¶ä»–æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
         document.querySelectorAll('.voice-player').forEach(otherBtn => {
             if (otherBtn !== button) {
                 otherBtn.textContent = 'â–¶';
                 // ç§»é™¤ä¸æŒ‰é’®å…³è”çš„audioBufferSourceNode
                 if (otherBtn.audioSource) {
                     try {
                         otherBtn.audioSource.stop();
                         otherBtn.audioSource.disconnect();
                     } catch (e) {
                         console.error("åœæ­¢å…¶ä»–éŸ³é¢‘æ—¶å‡ºé”™:", e);
                     }
                     delete otherBtn.audioSource;
                     otherBtn.isPlaying = false;
                     console.log("åœæ­¢äº†å…¶ä»–æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘");
                 }
             }
         });

         // æ£€æŸ¥æŒ‰é’®ä¸­æ˜¯å¦å·²æœ‰éŸ³é¢‘æº
         if (button.audioSource) {
             // å¦‚æœéŸ³é¢‘æ­£åœ¨æ’­æ”¾ï¼Œåˆ™åœæ­¢
             if (button.isPlaying) {
                 console.log("æš‚åœäº†å½“å‰éŸ³é¢‘");
                 try {
                     button.audioSource.stop();
                     button.audioSource.disconnect();
                 } catch (e) {
                     console.error("åœæ­¢å½“å‰éŸ³é¢‘æ—¶å‡ºé”™:", e);
                 }
                 delete button.audioSource;
                 button.isPlaying = false;
                 button.textContent = 'â–¶';
             } else {
                 // æŒ‰é’®æ ‡è®°ä¸ºæ’­æ”¾çŠ¶æ€ä½†æ²¡æœ‰å®é™…æ’­æ”¾ï¼Œé‡æ–°åŠ è½½æ’­æ”¾
                 try {
                     if (button.audioSource) {
                         button.audioSource.stop();
                         button.audioSource.disconnect();
                     }
                 } catch (e) {
                     console.error("æ¸…ç†éŸ³é¢‘æºæ—¶å‡ºé”™:", e);
                 }
                 delete button.audioSource;
                 console.log("æ¢å¤æ’­æ”¾éŸ³é¢‘ï¼ŒæºURL:", audioSrc);
                 loadAndPlayAudio(audioSrc, button, ctx);
             }
         } else {
             // åˆ›å»ºå¹¶æ’­æ”¾æ–°çš„éŸ³é¢‘
             console.log("åˆ›å»ºæ–°çš„éŸ³é¢‘æºèŠ‚ç‚¹ï¼ŒæºURL:", audioSrc);
             loadAndPlayAudio(audioSrc, button, ctx);
         }
     }

     /**
      * åŠ è½½å¹¶æ’­æ”¾éŸ³é¢‘æ–‡ä»¶
      */
     function loadAndPlayAudio(audioSrc, button, audioContext) {
        console.log("å¼€å§‹åŠ è½½éŸ³é¢‘æ–‡ä»¶:", audioSrc);
        button.textContent = 'â³'; // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€

        // éªŒè¯éŸ³é¢‘URLæ ¼å¼
        if (!audioSrc || typeof audioSrc !== 'string' || audioSrc.trim() === '') {
            console.error("æ— æ•ˆçš„éŸ³é¢‘URL:", audioSrc);
            button.textContent = 'â–¶';
            return;
        }

        // ç¡®ä¿éŸ³é¢‘URLæ˜¯å®Œæ•´çš„HTTP/HTTPS URL
        let fullAudioSrc = audioSrc.trim();
        if (!fullAudioSrc.startsWith('http://') && !fullAudioSrc.startsWith('https://')) {
            console.log("éŸ³é¢‘URLä¸å®Œæ•´ï¼Œå°è¯•æ·»åŠ å‰ç¼€:", fullAudioSrc);
            // å‡è®¾éŸ³é¢‘URLåº”è¯¥ä»asset.juheiot.cnå¼€å§‹
            if (fullAudioSrc.startsWith('//')) {
                fullAudioSrc = 'https:' + fullAudioSrc;
            } else if (fullAudioSrc.startsWith('asset.juheiot.cn')) {
                fullAudioSrc = 'https://' + fullAudioSrc;
            } else {
                // å¯èƒ½æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå°è¯•æ·»åŠ åŸºç¡€URL
                fullAudioSrc = 'https://asset.juheiot.cn/' + fullAudioSrc;
            }
            console.log("ä¿®æ­£åçš„éŸ³é¢‘URL:", fullAudioSrc);
        }

        // æ£€æŸ¥AudioContextå½“å‰çŠ¶æ€
        console.log("åŠ è½½éŸ³é¢‘æ—¶AudioContextçŠ¶æ€:", audioContext.state);

        // å†æ¬¡æ£€æŸ¥å¹¶ç¡®ä¿AudioContextå¤„äºrunningçŠ¶æ€
        if (audioContext.state !== 'running') {
            audioContext.resume().then(() => {
                console.log("loadAndPlayAudioä¸­æ¢å¤AudioContextæˆåŠŸï¼ŒçŠ¶æ€:", audioContext.state);
                playAudioDirect(fullAudioSrc);
            }).catch(e => {
                console.error("loadAndPlayAudioä¸­æ¢å¤AudioContextå¤±è´¥:", e);
                button.textContent = 'â–¶';
                alert(`éŸ³é¢‘åŠ è½½å¤±è´¥: æ— æ³•æ¢å¤AudioContext (é”™è¯¯: ${e.message})`);
            });
        } else {
            playAudioDirect(fullAudioSrc);
        }
    }



     function playAudioDirect(url) {
        console.log("ğŸµ å°è¯•ç›´æ¥ç”¨ <audio> æ’­æ”¾:", url);
        const audio = new Audio(url);
        audio.autoplay = true;   // è‡ªåŠ¨æ’­æ”¾
        audio.onerror = (err) => {
            console.error("âŒ HTML5 Audio æ’­æ”¾å¤±è´¥:", err);
        };
        audio.onplay = () => {
            console.log("âœ… HTML5 Audio å·²å¼€å§‹æ’­æ”¾:", url);
        };
    }

     function playLocalTestToneFirst(button, audioContext) {
         try {
             console.log("ä¼˜å…ˆæ’­æ”¾æœ¬åœ°æµ‹è¯•éŸ³...");

             // å†æ¬¡æ£€æŸ¥AudioContextçŠ¶æ€
             if (!audioContext) {
                 throw new Error("AudioContextä¸å­˜åœ¨");
             }

             // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥ç”Ÿæˆå’Œæ’­æ”¾æµ‹è¯•éŸ³
             function generateAndPlayTestTone() {
                 // åˆ›å»ºéŸ³é¢‘ç¼“å†²åŒºï¼Œé•¿åº¦ä¸º1ç§’
                 const testBuffer = audioContext.createBuffer(1, audioContext.sampleRate, audioContext.sampleRate);
                 const channelData = testBuffer.getChannelData(0);

                 // ç”Ÿæˆæ›´è‡ªç„¶çš„æµ‹è¯•éŸ³ï¼šä½¿ç”¨å¤šä¸ªé¢‘ç‡çš„ç»„åˆï¼Œå¹¶æ·»åŠ æ·¡å‡ºæ•ˆæœ
                 for (let i = 0; i < testBuffer.length; i++) {
                     const time = i / testBuffer.sampleRate;

                     // ä½¿ç”¨å¤šä¸ªé¢‘ç‡ç»„åˆï¼Œé¿å…å•ä¸€é¢‘ç‡çš„é•¿é¸£
                     const fundamentalFreq = 440; // åŸºç¡€é¢‘ç‡
                     const harmonic1 = 880;      // äºŒæ¬¡è°æ³¢
                     const harmonic2 = 1320;    // ä¸‰æ¬¡è°æ³¢

                     // åˆ›å»ºæ›´ä¸°å¯Œçš„æ³¢å½¢
                     let sample = (
                         0.5 * Math.sin(2 * Math.PI * fundamentalFreq * time) +
                         0.2 * Math.sin(2 * Math.PI * harmonic1 * time) +
                         0.1 * Math.sin(2 * Math.PI * harmonic2 * time)
                     );

                     // æ·»åŠ æ·¡å‡ºæ•ˆæœï¼Œä½¿ç»“æŸæ›´è‡ªç„¶
                     const fadeOutStart = 0.7; // ä»0.7ç§’å¼€å§‹æ·¡å‡º
                     const fadeOutLength = 0.3; // æ·¡å‡ºæ—¶é—´0.3ç§’

                     if (time > fadeOutStart) {
                         const fadeProgress = (time - fadeOutStart) / fadeOutLength;
                         const fadeFactor = Math.max(0, 1 - fadeProgress);
                         sample *= fadeFactor;
                     }

                     channelData[i] = sample * 0.3; // é™ä½æ•´ä½“éŸ³é‡
                 }

                 // åˆ›å»ºéŸ³é¢‘æºèŠ‚ç‚¹
                 const source = audioContext.createBufferSource();
                 source.buffer = testBuffer;

                 // æ·»åŠ éŸ³é‡æ§åˆ¶
                 const gainNode = audioContext.createGain();
                 gainNode.gain.value = 0.5; // è®¾ç½®è¾ƒä½çš„éŸ³é‡

                 // è¿æ¥èŠ‚ç‚¹
                 source.connect(gainNode);
                 gainNode.connect(audioContext.destination);

                 // ä¿å­˜åˆ°æŒ‰é’®å…ƒç´ ä¸Šï¼ˆæ ‡è®°ä¸ºæµ‹è¯•éŸ³ï¼‰
                 button.audioSource = source;
                 button.isTestTone = true;
                 button.isPlaying = true;
                 button.textContent = 'â¸';

                 // ç›‘å¬æ’­æ”¾ç»“æŸäº‹ä»¶
                 source.onended = () => {
                     console.log("æµ‹è¯•éŸ³é¢‘æ’­æ”¾ç»“æŸ");
                     if (button.isTestTone) { // åªæœ‰åœ¨æµ‹è¯•éŸ³æ’­æ”¾ç»“æŸæ—¶æ‰æ›´æ–°çŠ¶æ€
                         button.isPlaying = false;
                         button.textContent = 'â–¶';
                         delete button.audioSource;
                         delete button.isTestTone;
                     }
                 };

                 // å¼€å§‹æ’­æ”¾
                 source.start();
                 console.log("æµ‹è¯•éŸ³é¢‘å·²å¼€å§‹æ’­æ”¾");
             }

             // æ£€æŸ¥å¹¶å°è¯•æ¢å¤AudioContextçŠ¶æ€
             if (audioContext.state !== 'running') {
                 console.log("å›é€€æ—¶AudioContextçŠ¶æ€ä¸æ˜¯runningï¼Œå°è¯•æ¢å¤...", audioContext.state);

                 audioContext.resume().then(() => {
                     console.log("å›é€€æ—¶æ¢å¤AudioContextæˆåŠŸï¼Œå½“å‰çŠ¶æ€:", audioContext.state);
                     // æ¢å¤æˆåŠŸåç”Ÿæˆå¹¶æ’­æ”¾æµ‹è¯•éŸ³
                     generateAndPlayTestTone();
                 }).catch(resumeError => {
                     console.error("å›é€€æ—¶æ¢å¤AudioContextå¤±è´¥:", resumeError);
                     button.textContent = 'â–¶';
                     alert(`æ— æ³•æ’­æ”¾æµ‹è¯•éŸ³: æ— æ³•æ¢å¤AudioContext (çŠ¶æ€: ${audioContext.state})`);
                 });
             } else {
                 // AudioContextå·²ç»åœ¨è¿è¡ŒçŠ¶æ€ï¼Œç›´æ¥ç”Ÿæˆå¹¶æ’­æ”¾æµ‹è¯•éŸ³
                 generateAndPlayTestTone();
             }
         } catch (fallbackError) {
             console.error("æµ‹è¯•éŸ³ç”Ÿæˆå¤±è´¥:", fallbackError);
             button.textContent = 'â–¶';
             alert(`æµ‹è¯•éŸ³ç”Ÿæˆå¤±è´¥: ${fallbackError.message || 'æœªçŸ¥é”™è¯¯'}`);
         }
     }

     /**
      * åœ¨åå°å°è¯•åŠ è½½ç½‘ç»œéŸ³é¢‘
      */
     function tryLoadNetworkAudioInBackground(fullAudioSrc, button, audioContext) {
         // è®¾ç½®é‡è¯•é…ç½®
         const maxRetries = 2; // æœ€å¤šé‡è¯•2æ¬¡
         let retryCount = 0;

         // å®šä¹‰é‡è¯•å‡½æ•°
         function attemptLoadAudio() {
             // å°è¯•ä½¿ç”¨fetchåŠ è½½éŸ³é¢‘æ–‡ä»¶
             console.log(`åœ¨åå°å°è¯•åŠ è½½ç½‘ç»œéŸ³é¢‘${retryCount > 0 ? `(ç¬¬${retryCount+1}æ¬¡å°è¯•)` : ''}...`);
             try {
                 // ç®€åŒ–fetchè¯·æ±‚é…ç½®ï¼Œåªä¿ç•™å¿…è¦çš„è·¨åŸŸè®¾ç½®
                fetch(fullAudioSrc, {
                     mode: 'cors',
                     credentials: 'include',
                     method: 'GET',
                     headers: {
                         'Accept': 'audio/*'
                     }
                 })
            .then(response => {
                console.log("éŸ³é¢‘fetchå“åº”çŠ¶æ€:", response.status, response.statusText);
                console.log("å“åº”å¤´Content-Type:", response.headers.get('content-type'));
                console.log("å“åº”å¤´Content-Length:", response.headers.get('content-length'));

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}, çŠ¶æ€: ${response.statusText}`);
                }

                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹æ˜¯å¦ä¸ºéŸ³é¢‘
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.startsWith('audio/')) {
                    console.warn("å“åº”å†…å®¹å¯èƒ½ä¸æ˜¯éŸ³é¢‘æ–‡ä»¶ï¼ŒContent-Type:", contentType);
                    // ä»ç„¶å°è¯•è§£ç ï¼Œå› ä¸ºæœ‰äº›æœåŠ¡å™¨å¯èƒ½è¿”å›é”™è¯¯çš„MIMEç±»å‹
                }

                return response.arrayBuffer();
            })
               .then(arrayBuffer => {
                   console.log("éŸ³é¢‘æ–‡ä»¶å·²ä¸‹è½½ï¼Œæ•°æ®é•¿åº¦:", arrayBuffer.byteLength, "å­—èŠ‚");

                   // æ£€æŸ¥arrayBufferæ˜¯å¦ä¸ºç©º
                   if (arrayBuffer.byteLength === 0) {
                       throw new Error("ä¸‹è½½çš„éŸ³é¢‘æ–‡ä»¶ä¸ºç©º");
                   }

                   // å°è¯•è§£ç éŸ³é¢‘æ•°æ®
                   return audioContext.decodeAudioData(arrayBuffer)
                       .catch(err => {
                           console.error("éŸ³é¢‘è§£ç å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ³•è§£ç :", err);
                           // å¯èƒ½æ˜¯å› ä¸ºéŸ³é¢‘æ ¼å¼ä¸æ”¯æŒï¼Œè¿™é‡Œå°è¯•åˆ›å»ºä¸€ä¸ªç®€å•çš„éŸ³è°ƒè¿›è¡Œæµ‹è¯•
                           // è¿™æ˜¯ä¸€ä¸ªæ•…éšœæ’é™¤æ­¥éª¤ï¼Œç”¨äºæµ‹è¯•Web Audio APIæœ¬èº«æ˜¯å¦æ­£å¸¸å·¥ä½œ
                           const testBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 2, audioContext.sampleRate);
                           const channelData = testBuffer.getChannelData(0);
                           for (let i = 0; i < testBuffer.length; i++) {
                               // ç”Ÿæˆä¸€ä¸ªç®€å•çš„æ­£å¼¦æ³¢ä½œä¸ºæµ‹è¯•éŸ³
                               channelData[i] = Math.sin(440 * 2 * Math.PI * i / testBuffer.sampleRate);
                           }
                           return testBuffer;
                       });
               })
               .then(audioBuffer => {
                   console.log("éŸ³é¢‘è§£ç æˆåŠŸï¼Œå‡†å¤‡æ›¿æ¢æµ‹è¯•éŸ³...");

                   // åœæ­¢å½“å‰å¯èƒ½æ­£åœ¨æ’­æ”¾çš„æµ‹è¯•éŸ³
                   if (button.audioSource && button.isTestTone) {
                       try {
                           button.audioSource.stop();
                           button.audioSource.disconnect();
                           console.log("å·²åœæ­¢æµ‹è¯•éŸ³æ’­æ”¾");
                       } catch (stopError) {
                           console.error("åœæ­¢æµ‹è¯•éŸ³æ—¶å‡ºé”™:", stopError);
                       }
                   }

                   // åˆ›å»ºéŸ³é¢‘æºèŠ‚ç‚¹
                   const source = audioContext.createBufferSource();
                   source.buffer = audioBuffer;

                   // æ·»åŠ éŸ³é‡æ§åˆ¶
                   const gainNode = audioContext.createGain();
                   gainNode.gain.value = 1.0; // è®¾ç½®éŸ³é‡ï¼ˆ1.0ä¸ºæ­£å¸¸ï¼‰

                   // è¿æ¥èŠ‚ç‚¹
                   source.connect(gainNode);
                   gainNode.connect(audioContext.destination);

                   // ä¿å­˜åˆ°æŒ‰é’®å…ƒç´ ä¸Šï¼Œæ ‡è®°ä¸ºçœŸå®éŸ³é¢‘
                   button.audioSource = source;
                   button.isTestTone = false; // æ ‡è®°ä¸ºçœŸå®éŸ³é¢‘
                   button.isPlaying = true;
                   button.textContent = 'â¸';

                   // ç›‘å¬æ’­æ”¾ç»“æŸäº‹ä»¶
                   source.onended = () => {
                       console.log("çœŸå®éŸ³é¢‘æ’­æ”¾ç»“æŸ");
                       button.isPlaying = false;
                       button.textContent = 'â–¶';
                       delete button.audioSource;
                   };

                   // å¼€å§‹æ’­æ”¾çœŸå®éŸ³é¢‘
                   source.start();
                   console.log("çœŸå®éŸ³é¢‘å·²å¼€å§‹æ’­æ”¾");
               })
             .catch(error => {
                 console.error("åå°åŠ è½½ç½‘ç»œéŸ³é¢‘å¤±è´¥:", error);

                 // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”æœªè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåˆ™è¿›è¡Œé‡è¯•
                 if ((error.name === 'TypeError' || error.message.includes('Failed to fetch')) && retryCount < maxRetries) {
                     retryCount++;
                     console.log(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œ${retryCount}ç§’åè¿›è¡Œç¬¬${retryCount}æ¬¡é‡è¯•...`);
                     setTimeout(attemptLoadAudio, retryCount * 1000); // é€’å¢çš„é‡è¯•é—´éš”
                 } else {
                     console.error(`fetchæ–¹å¼éŸ³é¢‘åŠ è½½æœ€ç»ˆå¤±è´¥ï¼ˆå·²å°è¯•${retryCount+1}æ¬¡ï¼‰:`, error);
                     try {
                         console.log("å°è¯•ä½¿ç”¨HTML5 Audioå…ƒç´ ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆåŠ è½½éŸ³é¢‘...");
                         const audioElement = new Audio(fullAudioSrc);
                         audioElement.crossOrigin = 'anonymous';
                         audioElement.addEventListener('canplaythrough', () => {
                             console.log("HTML5 Audioå…ƒç´ åŠ è½½éŸ³é¢‘æˆåŠŸ");
                             if (button.audioSource && button.isTestTone) {
                                 try {
                                     button.audioSource.stop();
                                     button.audioSource.disconnect();
                                     console.log("å·²åœæ­¢æµ‹è¯•éŸ³æ’­æ”¾");
                                 } catch (stopError) {
                                     console.error("åœæ­¢æµ‹è¯•éŸ³æ—¶å‡ºé”™:", stopError);
                                 }
                             }

                             audioElement.play().then(() => {
                                 console.log("é€šè¿‡Audioå…ƒç´ æ’­æ”¾éŸ³é¢‘æˆåŠŸ");
                                 button.isPlaying = true;
                                 button.textContent = 'â¸';
                                 audioElement.addEventListener('ended', () => {
                                     console.log("Audioå…ƒç´ éŸ³é¢‘æ’­æ”¾ç»“æŸ");
                                     button.isPlaying = false;
                                     button.textContent = 'â–¶';
                                 });
                             }).catch(playError => {
                                 console.error("Audioå…ƒç´ æ’­æ”¾å¤±è´¥:", playError);
                                 button.textContent = 'â–¶';
                             });
                         });

                         audioElement.addEventListener('error', (audioError) => {
                             console.error("HTML5 Audioå…ƒç´ åŠ è½½éŸ³é¢‘ä¹Ÿå¤±è´¥äº†:", audioError);

                             if (!button.retryButton) {
                                 const retryBtn = document.createElement('span');
                                 retryBtn.textContent = 'ğŸ”„';
                                 retryBtn.style.cursor = 'pointer';
                                 retryBtn.style.marginLeft = '5px';
                                 retryBtn.style.fontSize = '12px';
                                 retryBtn.title = 'é‡æ–°å°è¯•åŠ è½½ç½‘ç»œéŸ³é¢‘';
                                 retryBtn.onclick = (e) => {
                                     e.stopPropagation(); // é˜²æ­¢è§¦å‘æ’­æ”¾æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                                     console.log('ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ç½‘ç»œéŸ³é¢‘é‡è¯•...');
                                     retryBtn.remove();
                                     delete button.retryButton;
                                     tryLoadNetworkAudioInBackground(fullAudioSrc, button, audioContext);
                                 };
                                 button.retryButton = retryBtn;
                                 button.parentNode.insertBefore(retryBtn, button.nextSibling);
                             }
                         });

                         audioElement.preload = 'auto';
                         audioElement.load();
                     } catch (audioElementError) {
                         console.error("åˆ›å»ºAudioå…ƒç´ å¤±è´¥:", audioElementError);
                         if (!button.retryButton) {
                             const retryBtn = document.createElement('span');
                             retryBtn.textContent = 'ğŸ”„';
                             retryBtn.style.cursor = 'pointer';
                             retryBtn.style.marginLeft = '5px';
                             retryBtn.style.fontSize = '12px';
                             retryBtn.title = 'é‡æ–°å°è¯•åŠ è½½ç½‘ç»œéŸ³é¢‘';
                             retryBtn.onclick = (e) => {
                                 e.stopPropagation();
                                 console.log('ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ç½‘ç»œéŸ³é¢‘é‡è¯•...');
                                 retryBtn.remove();
                                 delete button.retryButton;
                                 tryLoadNetworkAudioInBackground(fullAudioSrc, button, audioContext);
                             };
                             button.retryButton = retryBtn;
                             button.parentNode.insertBefore(retryBtn, button.nextSibling);
                         }
                     }
                 }
             });
         } catch (e) {
             console.error("åå°fetchè¯·æ±‚åˆå§‹åŒ–å¤±è´¥:", e);
         }
         } // attemptLoadAudioå‡½æ•°ç»“æŸ

         // å¼€å§‹ç¬¬ä¸€æ¬¡å°è¯•
         attemptLoadAudio();
     }


    /**
     * æ‰“å¼€èŠå¤©å¯¹è¯æ¡†
     * @param {number} roomId - æˆ¿é—´ID
     * @param {string} roomName - æˆ¿é—´åç§°
     */
    async function openChatDialog(roomId, roomName) {
        // è®¾ç½®å½“å‰æˆ¿é—´ä¿¡æ¯
        state.current_room_id = roomId;
        state.current_room_name = roomName;

        // æ›´æ–°å¯¹è¯æ¡†æ ‡é¢˜
        ui.chatTitle.textContent = roomName;

        // æ˜¾ç¤ºå¯¹è¯æ¡†å’Œé®ç½©å±‚
        ui.chatDialog.style.display = 'flex';
        ui.chatOverlay.style.display = 'block';

        // è·å–å¹¶æ¸²æŸ“è¯­éŸ³æ¶ˆæ¯
        const messages = await fetchVoiceMessages(roomId);
        renderVoiceMessages(messages);
    }

    /**
     * å…³é—­èŠå¤©å¯¹è¯æ¡†
     */
    function closeChatDialog() {
        // éšè—å¯¹è¯æ¡†å’Œé®ç½©å±‚
        ui.chatDialog.style.display = 'none';
        ui.chatOverlay.style.display = 'none';

        // æ¸…ç©ºå½“å‰æˆ¿é—´ä¿¡æ¯
        state.current_room_id = null;
        state.current_room_name = null;

        // åœæ­¢æ‰€æœ‰æ’­æ”¾çš„éŸ³é¢‘ï¼ˆä½¿ç”¨Web Audio APIçš„æ–¹å¼ï¼‰
        document.querySelectorAll('.voice-player').forEach(button => {
            if (button.audioSource) {
                button.audioSource.stop();
                button.audioSource.disconnect();
                delete button.audioSource;
            }
            button.textContent = 'â–¶';
            button.isPlaying = false;
        });
    }

    /**
     * è¿æ¥WebSocket
     */
    function connectWebSocket() {
        if (state.websocket) {
            state.websocket.close();
        }

        const wsUrl = `${config.ws_url}?token=${state.token}`;
        console.log(`[${new Date().toLocaleString()}] å°è¯•è¿æ¥WebSocket: ${wsUrl}`);
        state.websocket = new WebSocket(wsUrl);

        state.websocket.onopen = () => {
            console.log("WebSocketè¿æ¥æˆåŠŸï¼");
            startHeartbeat();
        };

        state.websocket.onmessage = (event) => {
            const message = event.data;
            console.log(`[${new Date().toLocaleString()}] æ”¶åˆ°WebSocketæ¶ˆæ¯:`, message.length > 50 ? message.substring(0, 50) + '...' : message);
            console.log(`[è°ƒè¯•] æ¶ˆæ¯é•¿åº¦: ${message.length}, æ¶ˆæ¯ç±»å‹: ${typeof message}`);

            if (message.startsWith("time") && message.length === 17) {
                console.log("ã€æ¶ˆæ¯ç±»å‹ï¼šå¿ƒè·³å›æ‰§ã€‘");
                 ui.heartbeatStatus.textContent = `å¿ƒè·³: ${Date.now() - parseInt(message.substring(4), 10)}ms`;
                return;
            }

            console.log("ã€æ¶ˆæ¯ç±»å‹ï¼šä¸šåŠ¡æ¶ˆæ¯ã€‘");
            if (isNewMessage(message)) {
                // å°è¯•è§£ææ¶ˆæ¯æ•°æ®
                let messageData = { roomId: state.current_room_id };
                try {
                    messageData = JSON.parse(message);
                } catch (e) {
                    console.log("æ¶ˆæ¯ä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•æå–roomId");
                    // ä½¿ç”¨æ›´å®½æ¾çš„æ­£åˆ™è¡¨è¾¾å¼æå–roomId
                    const roomIdMatch = message.match(/roomId"?:"?([0-9]+)/);
                    if (roomIdMatch && roomIdMatch[1]) {
                        messageData.roomId = roomIdMatch[1];
                        console.log(`[è°ƒè¯•] ä»éJSONæ¶ˆæ¯ä¸­æå–åˆ°roomId: ${messageData.roomId}`);
                    }
                }

                console.log(`[è°ƒè¯•] å³å°†å¤„ç†æ–°æ¶ˆæ¯é€šçŸ¥ï¼ŒmessageData:`, messageData);
                handleNewMessageNotification(messageData);

                if (state.current_room_id) {
                    fetchVoiceMessages(state.current_room_id).then(messages => {
                        if (messages.length > 0) {
                            console.log("æ”¶åˆ°æ–°æ¶ˆæ¯åï¼Œè·å–åˆ°æœ€æ–°è¯­éŸ³æ¶ˆæ¯");
                            renderVoiceMessages(messages);

                            const lastMessage = ui.chatMessages.lastElementChild;
                            if (lastMessage) {
                                lastMessage.classList.add('new-message-animation');
                                setTimeout(() => {
                                    lastMessage.classList.remove('new-message-animation');
                                }, 1000);
                            }
                        }
                    });
                } else {
                    console.log("æœªé€‰æ‹©æˆ¿é—´ï¼Œæš‚ä¸åˆ·æ–°è¯­éŸ³æ¶ˆæ¯åˆ—è¡¨");
                }
            }
        };

        state.websocket.onclose = () => {
            console.log("WebSocketè¿æ¥å·²å…³é—­ï¼Œ5ç§’åå°è¯•é‡è¿...");
            stopHeartbeat();
            setTimeout(connectWebSocket, 5000);
        };

        state.websocket.onerror = (error) => {
            console.error("WebSocketå‘ç”Ÿé”™è¯¯:", error);
            state.websocket.close(); // è§¦å‘ onclose ä¸­çš„é‡è¿é€»è¾‘
        };
    }

    /**
     * å¯åŠ¨å¿ƒè·³
     */
    function startHeartbeat() {
        stopHeartbeat(); // å…ˆåœæ­¢æ—§çš„
        const sendHeartbeat = () => {
            if (state.websocket && state.websocket.readyState === WebSocket.OPEN) {
                const heartbeatMsg = `time${Date.now()}`;
                state.websocket.send(heartbeatMsg);
                console.log(`[${new Date().toLocaleString()}] å‘é€å¿ƒè·³åŒ…: ${heartbeatMsg}`);
            }
        };
        sendHeartbeat(); // ç«‹å³å‘é€ä¸€æ¬¡
        state.heartbeat_timer = setInterval(sendHeartbeat, config.heartbeat_interval);
    }

    /**
     * åœæ­¢å¿ƒè·³
     */
    function stopHeartbeat() {
        if(state.heartbeat_timer) {
            clearInterval(state.heartbeat_timer);
            state.heartbeat_timer = null;
        }
    }

    /**
     * æ›´æ–°é¡¶éƒ¨æ—¶é’Ÿ
     */
    function updateClock() {
        const now = new Date();
        const time = now.toTimeString().split(' ')[0];
        const date = `${String(now.getMonth() + 1).padStart(2, '0')}æœˆ${String(now.getDate()).padStart(2, '0')}æ—¥`;
        ui.currentTime.textContent = time;
        ui.currentDate.textContent = date;
    }

    /**
     * å¤„ç†é€€å‡ºç™»å½•åŠŸèƒ½
     */
    async function handleLogout() {
        if (!state.token) {
            console.warn('æœªç™»å½•çŠ¶æ€ï¼Œæ— éœ€é€€å‡º');
            return;
        }

        try {
            // ç”Ÿæˆç­¾åå’Œæ—¶é—´æˆ³
            const { sign, timestamp } = generateSign(state.token);

            // æ„å»ºè¯·æ±‚å¤´ï¼Œä¸å…¶ä»–æ¥å£ä¿æŒä¸€è‡´
            const headers = {
                "Content-Type": "application/json",
                "deviceid": config.device_id,
                "devicetype": "pc",
                "fromapp": "pc",
                "fromplat": "all",
                "mobiletype": "web",
                "sign": sign,
                "timestamp": timestamp,
                "token": state.token,
                "version": config.version
            };

            // è°ƒç”¨é€€å‡ºç™»å½•æ¥å£
            const response = await fetch('https://vapi.juheiot.cn/apiv1/user/logout', {
                method: 'POST',
                headers: headers
            });

            const result = await response.json();

            console.log('é€€å‡ºç™»å½•å“åº”:', result);

            // æ— è®ºæ¥å£è¿”å›ä»€ä¹ˆï¼Œéƒ½æ¸…é™¤çŠ¶æ€å¹¶è¿”å›ç™»å½•é¡µ
            state.token = null;
            state.current_room_id = null;
            state.current_room_name = null;

            // å…³é—­WebSocketè¿æ¥
            if (state.websocket) {
                state.websocket.close();
                state.websocket = null;
                stopHeartbeat();
            }

            // åˆ‡æ¢å›ç™»å½•é¡µé¢
            ui.mainPage.style.display = 'none';
            ui.loginPage.style.display = 'flex';

        } catch (error) {
            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);

            // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå¼ºåˆ¶æ¸…é™¤çŠ¶æ€å¹¶è¿”å›ç™»å½•é¡µ
            state.token = null;
            state.current_room_id = null;
            state.current_room_name = null;

            // å…³é—­WebSocketè¿æ¥
            if (state.websocket) {
                state.websocket.close();
                state.websocket = null;
                stopHeartbeat();
            }

            ui.mainPage.style.display = 'none';
            ui.loginPage.style.display = 'flex';
        }
    }

    /**
     * å¤„ç†ç¾¤å‘åŠŸèƒ½
     */
    function handleBroadcast() {
        if (!state.token) {
            alert('è¯·å…ˆç™»å½•ï¼');
            return;
        }

        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„è¯­éŸ³å½•å…¥ç•Œé¢
        const overlay = document.createElement('div');
        overlay.className = 'broadcast-overlay';
        overlay.innerHTML = `
            <div class="broadcast-panel">
                <h3>ç¾¤å‘è¯­éŸ³</h3>
                <p>æŒ‰ä½ä¸‹æ–¹æŒ‰é’®å¼€å§‹å½•åˆ¶ï¼Œæ¾å¼€ç»“æŸå½•åˆ¶</p>
                <button id="broadcast-record-button" class="broadcast-record-button">æŒ‰ä½è¯´è¯</button>
                <p id="broadcast-status">ç‚¹å‡»å¼€å§‹å½•åˆ¶</p>
                <button id="broadcast-cancel" class="broadcast-cancel">å–æ¶ˆ</button>
            </div>
        `;
        document.body.appendChild(overlay);

        const recordButton = overlay.querySelector('#broadcast-record-button');
        const statusText = overlay.querySelector('#broadcast-status');
        const cancelButton = overlay.querySelector('#broadcast-cancel');
        let isRecording = false;
        let recordingStartTime = 0;
        let mediaRecorder = null;
        let stream = null;
        let audioBlob = null;
        let audioChunks = [];

        // åˆå§‹åŒ–éŸ³é¢‘å½•éŸ³å™¨
        async function initAudioRecorder() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new RecordRTC(stream, {
                    type: 'audio',
                    mimeType: 'audio/webm;codecs=pcm',
                    recorderType: RecordRTC.StereoAudioRecorder,
                    numberOfAudioChannels: 1,
                    desiredSampRate: 16000
                });
                return mediaRecorder;
            } catch (error) {
                console.error('åˆå§‹åŒ–å½•éŸ³å™¨å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
                return null;
            }
        }

        // å¼€å§‹å½•åˆ¶éŸ³é¢‘
        async function startRecording() {
            if (isRecording) return;

            if (!mediaRecorder) {
                mediaRecorder = await initAudioRecorder();
                if (!mediaRecorder) return;
            }

            // æ¸…ç©ºä¹‹å‰çš„å½•éŸ³æ•°æ®
            audioChunks = [];
            recordingStartTime = Date.now();
            isRecording = true;

            // å¼€å§‹å½•åˆ¶
            mediaRecorder.startRecording();

            // æ›´æ–°UI
            recordButton.classList.add('recording');
            statusText.textContent = 'æ¾å¼€ç»“æŸå½•åˆ¶';

            console.log('å¼€å§‹å½•éŸ³...');
        }

        // åœæ­¢å½•åˆ¶éŸ³é¢‘
        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;

            // åœæ­¢å½•åˆ¶
            mediaRecorder.stopRecording(async function() {
                const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                const webmBlob = mediaRecorder.getBlob();

                // è½¬æ¢ä¸ºMP3æ ¼å¼
                await convertToMP3(webmBlob, duration);

                // åœæ­¢éŸ³é¢‘æµ
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // é‡ç½®å½•éŸ³å™¨
                mediaRecorder = null;
            });

            // é‡ç½®å½•éŸ³çŠ¶æ€
            isRecording = false;

            // æ›´æ–°UI
            recordButton.classList.remove('recording');
            statusText.textContent = 'æ­£åœ¨å¤„ç†éŸ³é¢‘...';

            console.log('åœæ­¢å½•éŸ³...æ­£åœ¨å¤„ç†éŸ³é¢‘...');
        }

        // å¤„ç†MP3è½¬æ¢
        async function convertToMP3(webmBlob, duration) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = function(e) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        audioContext.decodeAudioData(e.target.result, async function(audioBuffer) {
                            // è½¬æ¢ä¸ºå•å£°é“
                            const channels = 1;
                            const sampleRate = 44100;
                            const kbps = 64;

                            const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, kbps);
                            const samples = audioBuffer.getChannelData(0);
                            const sampleBlockSize = 1152;
                            const mp3Data = [];

                            // è½¬æ¢ä¸º16ä½PCM
                            const samples16 = new Int16Array(samples.length);
                            for (let i = 0; i < samples.length; i++) {
                                samples16[i] = samples[i] * 0x7FFF;
                            }

                            for (let i = 0; i < samples16.length; i += sampleBlockSize) {
                                const sampleChunk = samples16.subarray(i, i + sampleBlockSize);
                                const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                                if (mp3buf.length > 0) {
                                    mp3Data.push(mp3buf);
                                }
                            }

                            const mp3buf = mp3encoder.flush();
                            if (mp3buf.length > 0) {
                                mp3Data.push(mp3buf);
                            }

                            audioBlob = new Blob(mp3Data, { type: 'audio/mp3' });
                            console.log('MP3æ–‡ä»¶å·²ç”Ÿæˆï¼Œå¤§å°:', audioBlob.size, 'å­—èŠ‚');

                            // ä¸Šä¼ éŸ³é¢‘
                            if (duration > 0 && state.token) {
                                await uploadBroadcastAudio(audioBlob, duration);
                            }

                            resolve();
                        }, function(error) {
                            console.error('éŸ³é¢‘è§£ç å¤±è´¥:', error);
                            reject(error);
                        });
                    } catch (error) {
                        console.error('MP3è½¬æ¢å¤±è´¥:', error);
                        reject(error);
                    }
                };
                fileReader.onerror = reject;
                fileReader.readAsArrayBuffer(webmBlob);
            });
        }

        // ä¸Šä¼ ç¾¤å‘éŸ³é¢‘
        async function uploadBroadcastAudio(audioBlob, duration) {
            if (!state.token) {
                console.error('æœªç™»å½•');
                return;
            }

            try {
                // ç”Ÿæˆæ¶ˆæ¯ID
                const msgId = generateMessageId();

                // è¯»å–MP3éŸ³é¢‘æ•°æ®ä¸ºBase64
                const reader = new FileReader();
                const audioBase64 = await new Promise((resolve, reject) => {
                    reader.onload = () => {
                        try {
                            let dataUrl = reader.result;
                            console.log('ç”Ÿæˆçš„DataURLï¼ˆå‰100å­—ç¬¦ï¼‰ï¼š', dataUrl.slice(0, 100));

                            // å¼ºå®¹é”™ï¼šä¸ç®¡æ ¼å¼å¦‚ä½•ï¼Œå¼ºåˆ¶æå–Base64éƒ¨åˆ†
                            let base64Str = '';
                            if (dataUrl.includes(',')) {
                                base64Str = dataUrl.split(',')[1];
                            } else if (dataUrl.includes('base64')) {
                                base64Str = dataUrl.split('base64')[1];
                            } else {
                                base64Str = dataUrl;
                            }

                            // éªŒè¯Base64æœ‰æ•ˆæ€§
                            base64Str = base64Str.trim();
                            if (base64Str.length % 4 !== 0) {
                                const padLength = 4 - (base64Str.length % 4);
                                if (padLength < 4) {
                                    base64Str += '='.repeat(padLength);
                                }
                            }

                            resolve(base64Str);
                        } catch (error) {
                            reject(new Error('Base64å¤„ç†å¤±è´¥: ' + error.message));
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(audioBlob);
                });

                console.log('å‡†å¤‡ä¸Šä¼ MP3éŸ³é¢‘æ•°æ®:', audioBlob.size, 'å­—èŠ‚');

                // ä½¿ç”¨ç°æœ‰generateSignå‡½æ•°ç”Ÿæˆç­¾åå’Œæ—¶é—´æˆ³
                const { sign, timestamp } = generateSign(state.token);

                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const params = {
                    data: audioBase64,
                    duration: duration.toString(),
                    msgId: msgId,
                    type: "mp3"
                };

                // æ„é€ å®Œæ•´è¯·æ±‚å¤´
                const headers = {
                    "accept": "application/json, text/plain, */*",
                    "accept-encoding": "gzip, deflate, br, zstd",
                    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
                    "Content-Type": "application/json",
                    "deviceid": config.device_id,
                    "devicetype": "pc",
                    "fromapp": "pc",
                    "fromplat": "all",
                    "mobiletype": "web",
                    "origin": "https://web.juheiot.cn",
                    "referer": "https://web.juheiot.cn/",
                    "sec-ch-ua": "\"Not;A=Brand\";v=\"99\", \"Microsoft Edge\";v=\"139\"",
                    "sec-ch-ua-mobile": "?0",
                    "sec-ch-ua-platform": "\"Windows\"",
                    "sign": sign,
                    "timestamp": timestamp,
                    "token": state.token,
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Edg/139.0.0.0",
                    "version": config.version
                };

                console.log('å‡†å¤‡ä¸Šä¼ éŸ³é¢‘åˆ°ç¾¤å‘APIæ¥å£:', {
                    url: 'https://vapi.juheiot.cn/apiv1/table/upHelpVoice',
                    params: params,
                    headers: headers
                });

                // å‘é€è¯·æ±‚åˆ°èšåˆAPIæœåŠ¡å™¨
                const response = await fetch('https://vapi.juheiot.cn/apiv1/table/upHelpVoice', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.code === 200) {
                    console.log('éŸ³é¢‘ä¸Šä¼ æˆåŠŸ:', result);
                    alert('ç¾¤å‘è¯­éŸ³å‘é€æˆåŠŸï¼');
                } else {
                    console.error('éŸ³é¢‘ä¸Šä¼ å¤±è´¥:', result);
                    alert('ç¾¤å‘è¯­éŸ³å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }

                // ç§»é™¤å¼¹çª—
                document.body.removeChild(overlay);
            } catch (error) {
                console.error('ä¸Šä¼ éŸ³é¢‘æ—¶å‘ç”Ÿé”™è¯¯:', error);
                alert('ä¸Šä¼ éŸ³é¢‘æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
                document.body.removeChild(overlay);
            }
        }

        // æ·»åŠ æŒ‰é’®äº‹ä»¶
        recordButton.addEventListener('mousedown', startRecording);
        recordButton.addEventListener('touchstart', startRecording);
        document.addEventListener('mouseup', stopRecording);
        document.addEventListener('touchend', stopRecording);

        cancelButton.addEventListener('click', () => {
            // åœæ­¢å½•éŸ³
            if (isRecording && mediaRecorder) {
                mediaRecorder.stopRecording();
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }
            document.body.removeChild(overlay);
        });

        // æ·»åŠ CSSæ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .broadcast-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }
            .broadcast-panel {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-radius: 15px;
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
                padding: 30px;
                width: 90%;
                max-width: 400px;
                text-align: center;
                color: white;
            }
            .broadcast-panel h3 {
                margin-top: 0;
                margin-bottom: 20px;
                font-size: 24px;
            }
            .broadcast-panel p {
                margin: 15px 0;
                font-size: 16px;
                opacity: 0.9;
            }
            .broadcast-record-button {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                border: none;
                background: linear-gradient(135deg, #f54e4e, #f09819);
                color: white;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.3s ease;
                margin: 20px 0;
                box-shadow: 0 4px 15px rgba(240, 152, 25, 0.4);
            }
            .broadcast-record-button:hover {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(240, 152, 25, 0.6);
            }
            .broadcast-record-button.recording {
                background: linear-gradient(135deg, #e53935, #c62828);
                box-shadow: 0 6px 20px rgba(229, 57, 53, 0.6), 0 0 30px rgba(229, 57, 53, 0.4);
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .broadcast-cancel {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 10px 20px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s ease;
            }
            .broadcast-cancel:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateY(-2px);
            }
        `;
        document.head.appendChild(style);
    }

    // --- åˆå§‹åŒ– ---

    ui.loginForm.addEventListener('submit', handleLogin);

    // æ·»åŠ è®¾ç½®å›¾æ ‡ç‚¹å‡»äº‹ä»¶
    const settingsIcon = document.querySelector('.settings-icon');
    const settingsDropdown = document.getElementById('settings-dropdown');
    const logoutItem = document.getElementById('logout-item');
    const broadcastItem = document.getElementById('broadcast-item');

    if (settingsIcon && settingsDropdown) {
        settingsIcon.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            settingsDropdown.classList.toggle('show');
        });

        // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', () => {
            if (settingsDropdown.classList.contains('show')) {
                settingsDropdown.classList.remove('show');
            }
        });

        // é˜»æ­¢ä¸‹æ‹‰æ¡†å†…ç‚¹å‡»äº‹ä»¶å†’æ³¡
        settingsDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // æ·»åŠ é€€å‡ºç™»å½•ç‚¹å‡»äº‹ä»¶
        if (logoutItem) {
            logoutItem.addEventListener('click', () => {
                settingsDropdown.classList.remove('show');
                handleLogout();
            });
        }

        // æ·»åŠ ç¾¤å‘ç‚¹å‡»äº‹ä»¶
        if (broadcastItem) {
            broadcastItem.addEventListener('click', () => {
                settingsDropdown.classList.remove('show');
                handleBroadcast();
            });
        }
    }
    updateClock();
    setInterval(updateClock, 1000);
    ui.chatClose.addEventListener('click', closeChatDialog);
    ui.chatOverlay.addEventListener('click', closeChatDialog);

    // å°†åŸæœ‰çš„ "click to toggle" æ¨¡å¼æ”¹å› "press and hold" (æŒ‰ä½å’Œæ¾å¼€) æ¨¡å¼
    if (ui.holdToTalkButton) {
        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        ui.holdToTalkButton.addEventListener('mousedown', startRecording);
        // é¼ æ ‡æ¾å¼€äº‹ä»¶
        ui.holdToTalkButton.addEventListener('mouseup', stopRecording);
        // é¼ æ ‡ç§»å‡ºæŒ‰é’®åŒºåŸŸä¹Ÿåœæ­¢å½•éŸ³
        ui.holdToTalkButton.addEventListener('mouseleave', stopRecording);

        // è§¦æ‘¸å±æŒ‰ä¸‹äº‹ä»¶
        ui.holdToTalkButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startRecording();
        });
        // è§¦æ‘¸å±æ¾å¼€äº‹ä»¶
        ui.holdToTalkButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRecording();
        });
    }

    ui.chatDialog.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && state.current_room_id !== null) {
            closeChatDialog();
        }
    });

});
</script>
</body>
</html>